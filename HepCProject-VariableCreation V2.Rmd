---
title: "Variable Creation"
output: word_document
---

```{r}
#libraries being used in this file
library(dplyr)
library(plyr)

```


#Segment patients with hep c at first encounter vs. after

#Create table patients

```{r}
########Find Hep C patients from icd diagnosis codes

##Match icd 9 codes per Dr Davis's email
hep_c_icd_dx <- subset(diagnosis_icd, 
                        icd_dx == "V02.62" | #Carrier or suspected carrier of Hep C (icd9)
                        icd_dx == "Z22.52" | #Carrier or suspected carrier of Hep C (icd10)
                        icd_dx == "V12.09" | #Hepatitis C, history of (icd9)
                        #icd_dx == "070.41" | #Acute hepatitis C with hepatic coma (icd9)
                        #icd_dx == "070.44" | #Chronic hepatitis C with hepatic coma (icd9)
                        #icd_dx == "070.51" | #Acute hepatitis C without mention of hepatic coma (icd9)
                        icd_dx == "070.54" | #Chronic hepatitis C without mention of hepatic coma; reat that it can be used as hep c in remission (icd9)
                        #icd_dx == "070.7" | #Unspecified viral hepatitis C (icd9)
                        icd_dx == "070.70" | #Unspecified viral hepatitis C without hepatic coma (icd9)
                        icd_dx == "070.71" | #Unspecified viral hepatitis C with hepatic coma (icd9)
                        icd_dx == "B19.20" | #Unspecified viral hepatitis C without hepatic coma (icd10)
                        icd_dx == "B1920" | #Unspecified viral hepatitis C without hepatic coma (icd10)
                        icd_dx == "B18.2" | #Chronic viral hep C (icd10)
                        #icd_dx == "B1710" | #Acute hepatitis C without hepatic coma (icd10)
                        icd_dx == "B19.21" | #Unspecified viral hepatitis C with hepatic coma (icd10)
                        icd_dx == "B1921"  #Unspecified viral hepatitis C with hepatic coma (icd10)
)

#Codes below were not included - These are icd 10 codes - there doesn't seem to be specific Hep C codes during pregnancy for icd 9
#"O98411" (icd10) - Viral hepatitis complicating pregnancy, first trimester
#"O98412" (icd10) - Viral hepatitis complicating pregnancy, second trimester
#"O9842" (icd10) - "VIRAL HEPATITIS COMPLICATING CHILDBIRTH"  
#"O98413" (icd10) - "VIRAL HEPATITIS COMP PREGNANCY THIRD TRIMESTER" 

dim(hep_c_icd_dx)#26540
#table(hep_c_icd_dx$icd_dx)
#table(hep_c_icd_dx$icd_diagnosis)


length(unique(hep_c_icd_dx$PATIENT_ID)) #3768 unique patient id's #3707

#####Find first hep c diagnosis dates#######

#Create an object with id numbers of unique patients with a Hep C icd code and the date of that first diagnosis date
#####

#find earilest hep C icd code using aggregate 
hep_c_patients_ids_first_hep_c_encounter_date <- aggregate(enc_dt_ds~PATIENT_ID,  data = hep_c_icd_dx, min) 

#rename encounter date column
names(hep_c_patients_ids_first_hep_c_encounter_date)[names(hep_c_patients_ids_first_hep_c_encounter_date) == "enc_dt_ds"] <- "First_Date_with_Hep_C_ICD_code"

#str(hep_c_patients_ids_first_hep_c_encounter_date)
#dim(hep_c_patients_ids_first_hep_c_encounter_date)
#length(unique(hep_c_patients_ids_first_hep_c_encounter_date$PATIENT_ID))

```




```{r}

##Finding first encounter date for Hep C patients
#Filter encounter table on Hep C patients only
hep_c_patient_encounters <- encounters[encounters$PATIENT_ID %in% hep_c_patients_ids_first_hep_c_encounter_date$PATIENT_ID,]
#names(hep_c_patient_encounters)

#reduce dataset to date and id field only
hep_c_patient_encounters_dates <- hep_c_patient_encounters[c("PATIENT_ID", "ENCOUNTER_ID", "PAT_ENC_CSN_ID_DID", "Enc_DT_DS", "Appt_DTTM_DS", "Appt_Checkin_DTTM", "Appt_Cancel_DTTM_DS", "ED_Arrival_DTTM_DS", "Hsp_Adm_DTTM_DS", "Hsp_Disch_DTTM_DS")]
#dim(hep_c_patient_encounters_dates)


#find min encounter date for hep C patients; change column name 
hep_c_patients_first_encounter_date <- aggregate(Enc_DT_DS~PATIENT_ID,  data = hep_c_patient_encounters_dates, min)
names(hep_c_patients_first_encounter_date)[names(hep_c_patients_first_encounter_date) == "Enc_DT_DS"] <- "First_Encounter_Date"

#merge encounter dates with first hep c diangosis date
hep_c_patients_first_encounter_date_and_first_hep_c_icd_code <- merge(hep_c_patients_first_encounter_date, hep_c_patients_ids_first_hep_c_encounter_date, by ="PATIENT_ID")


#Evaluate whether first enounter date is greater, less or equal to first encounter date - patients diagnosed within our periods of interest are "TRUE"
##BFORE = first encounter date is before first Hep C ICD code
##SAME = first encounter date is the same as first Hep C ICD code
hep_c_patients_first_encounter_date_and_first_hep_c_icd_code$EncountervsICD <- ifelse(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code$First_Encounter_Date < hep_c_patients_first_encounter_date_and_first_hep_c_icd_code$First_Date_with_Hep_C_ICD_code,  "BEFORE", "SAME")

nrow(subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == 'BEFORE'))  ##2485
nrow(subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == 'SAME'))  #1220

str(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code)
```



```{r}


#include patients whose first encounter date was < to first Hep C icd code - patients diagnosed during our time horizon
patients_include <- subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == "BEFORE")

#create table with all unique patient ID's from all tables except meds_inpt and meds_outpt
unique_pt_id_all_tbls<-as.data.frame(unique(c(cpt$PATIENT_ID,demo$PATIENT_ID,diagnosis_icd$PATIENT_ID,encounters$PATIENT_ID,procedure_icd$PATIENT_ID,social_hx$PATIENT_ID)))
names(unique_pt_id_all_tbls)[1]<-paste("PATIENT_ID")

#exclude patients who have hep c but didn't get it during our time horizon
patients_exclude <- subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == "SAME")

#master list of patients in scope for the analysis
patients <- left_join(unique_pt_id_all_tbls,patients_include)
old_rows<-nrow(patients)
patients<-anti_join(patients,patients_exclude, by = "PATIENT_ID")
new_rows<-nrow(patients)
deleted_rows<-old_rows-new_rows; deleted_rows

#Add column to identify as hep c = 1 and non hep c = 1
patients$HCV_STATUS <- ifelse(is.na(patients$First_Date_with_Hep_C_ICD_code),0,1)
patients<-patients[order(patients$PATIENT_ID),]

#double check - should be 2485
nrow(subset(patients, HCV_STATUS ==1))

#for patients who are not diagnosed with Hep_C make the First_Date_with_Hep_C_ICD_code 9999-12-31
patients$enddate<-as.Date.character("9999-12-31","%Y-%m-%d")
patients$first_date<-as.Date.numeric(ifelse(is.na(patients$First_Date_with_Hep_C_ICD_code),patients$enddate,patients$First_Date_with_Hep_C_ICD_code),origin = "1970-01-01")
patients$First_Date_with_Hep_C_ICD_code<-patients$first_date

#reduce to only patient ID and HCV status, first diagnosis date
patients <- patients[,c(1, 3, 5)]

#Filter encounter table on patietns in scope for analysis only
pt_encounters <- encounters[encounters$PATIENT_ID %in% patients$PATIENT_ID,]

#find min encounter date for hep C patients; change column name 
pts_first_encounter_date <- aggregate(Enc_DT_DS~PATIENT_ID,  data = pt_encounters, min)
names(pts_first_encounter_date)[names(pts_first_encounter_date) == "Enc_DT_DS"] <- "First_Encounter_Date"

#merge first encounter date with patient data 
patients <- left_join(patients, pts_first_encounter_date)

##remove patients without a first encounter date
patients <- patients[(!is.na(patients$First_Encounter_Date)),]

str(patients) #283661 patients


```

```{r}
#######Demo Varialbes#####

#merge patient id's with demo table

patients <- left_join(patients, demo) #add demographics table
dim(patients)
dim(demo)


## Age ##
library(eeptools)
patients$AGE <- (age_calc(dob = patients$DOB_DS, enddate = patients$First_Encounter_Date, units = "years"))  #calcuate age at time of first encounter
patients$AGE <- trunc(patients$AGE) #trunc to get whole number

## Bin Age #
patients$AGE_CATEGORY <- ifelse(patients$AGE >= 18 & patients$AGE <=24, "18-25",
                                ifelse(patients$AGE >= 25 & patients$AGE <=29, "25-29",
                                ifelse(patients$AGE >= 30 & patients$AGE <=34, "30-34",
                                ifelse(patients$AGE >= 35 & patients$AGE <=39, "35-39",
                                ifelse(patients$AGE >= 40 & patients$AGE <=44, "40-44",
                                ifelse(patients$AGE >= 45 & patients$AGE <=49, "45-49",
                                ifelse(patients$AGE >= 50 & patients$AGE <=54, "50-54",
                                ifelse(patients$AGE >= 55 & patients$AGE <=59, "55-59",
                                ifelse(patients$AGE >= 60 & patients$AGE <=64, "60-64",
                                ifelse(patients$AGE >= 65 & patients$AGE <=69, "65-69",
                                ifelse(patients$AGE >= 70 & patients$AGE <=74, "70-74",
                                ifelse(patients$AGE >= 75 & patients$AGE <=79, "75-79",
                                ifelse(patients$AGE >= 80 & patients$AGE <=84, "80-84",
                                ifelse(patients$AGE >= 85 & patients$AGE <=89, "85-89",
                                ifelse(patients$AGE >= 90 & patients$AGE <=94, "90-94",
                                ifelse(patients$AGE >= 95 & patients$AGE <=99, "95-99",
                                ifelse(patients$AGE >= 100 & patients$AGE <=104, "100-104",
                                ifelse(patients$AGE >= 105 & patients$AGE <=109, "105-109",
                                ifelse(patients$AGE >= 110 & patients$AGE <=115, "110-115", "Unknown")))))))))))))))))))       

patients$AGE_CATEGORY <- as.factor(patients$AGE_CATEGORY) #changing data strcture to factor

## reduce columans
patients <- patients[,c( "PATIENT_ID", "First_Date_with_Hep_C_ICD_code", "HCV_STATUS", "Gender", "Race", "Ethnicity", "language", "Marital_Status", "AGE_CATEGORY")] #reducing down the columns
names(patients)[c(4:8)] <- c("GENDER", "RACE", "ETHNICITY", "LANGUAGE", "MARITAL_STATUS") #rename columns

## Remove NA's
patients[,"RACE"][is.na(patients[,"RACE"])] <- "Unknown"
patients[,"ETHNICITY"][is.na(patients[,"ETHNICITY"])] <- "Unknown"

## Language ##
## reduce Language levels to 3 
levels(patients$LANGUAGE) <- c("Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Unknown")

patients[,"LANGUAGE"][is.na(patients[,"LANGUAGE"])] <- "Unknown" #changing NA's to "Unknonw"

## Marital Status ##
#reduce Marital Status levels to 4
levels(patients$MARITAL_STATUS) <- c("Married_Committed", "Married_Committed", "Unknown", "Divorced_Separated", 
                                     "Divorced_Separated", "Unknown", "Unknown", "Unknown", 
                                     "Unknown", "Divorced_Separated", "Divorced_Separated", "Unknown", 
                                     "Unknown", "Married_Committed", "Unknown", "Unknown", 
                                     "Married_Committed", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Single", "Unknown", 
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                    "Widowed", "Unknown", "Unknown", "Unknown", 
                                    "Unknown", "Unknown")

patients[,"MARITAL_STATUS"][is.na(patients[,"MARITAL_STATUS"])] <- "Unknown"

str(patients)
sum(is.na(patients))

```


```{r}
####  CINDY'S CODE #######
#-----------------------------------

######ICD Diagnosis Codes Table#########

###import value sets
HEDIS_value_sets <- read_delim("Z:/Value Sets/Value_Sets.csv", ",", escape_double = FALSE, trim_ws = TRUE)

HEDIS_value_sets <- HEDIS_value_sets[1:135657,] #dropping empty rows at end
tail(HEDIS_value_sets)
str(HEDIS_value_sets)

#reduce value sets to releveant sets and remove duplicate icd codes
hep_c_project_HEDIS_value_sets <- subset(HEDIS_value_sets, Value_Set_Name == "AOD Dependence" |
                                Value_Set_Name == "AOD Procedures" |
                                Value_Set_Name == "AOD Rehab and Detox" |
                                Value_Set_Name == "Chemical Dependency" |
                                Value_Set_Name == "Chlamydia Tests" |
                                Value_Set_Name == "Detoxification" |
                                Value_Set_Name == "Hepatitis A" |
                                Value_Set_Name == "Hepatitis B" |
                                Value_Set_Name == "HIV" |
                                Value_Set_Name == "IV Drug Abuse" |
                                Value_Set_Name == "Sexual Activity")
str(hep_c_project_HEDIS_value_sets) #2015 obserations

#For ICD codes
hep_c_project_HEDIS_icd_codes <- subset(hep_c_project_HEDIS_value_sets, Code_System == "ICD9CM" | Code_System == "ICD10CM") #only ICD diagnosis codes only

hep_c_project_HEDIS_icd_codes$Code <- gsub("\\..*", "", hep_c_project_HEDIS_icd_codes$Code) #drop the decimal point and any numbers after
hep_c_project_HEDIS_icd_codes$Code <- str_pad(hep_c_project_HEDIS_icd_codes$Code, 4, pad = "0") #pad so all codes are 4 characters long
hep_c_project_HEDIS_icd_codes <- hep_c_project_HEDIS_icd_codes[!duplicated(hep_c_project_HEDIS_icd_codes$Code),] #remove duplicates icd;

str(hep_c_project_HEDIS_icd_codes)
```

```{r}

#### ICD Codes ####
####  Combine icd table and cpt_ucpg table  ###########


#Join 2 tables with icd codes in them; reduce columns and rename

## Format icd table
reduced_diagnosis_icd <- diagnosis_icd[c("PATIENT_ID", "enc_dt_ds", "icd_dx", "icd_diagnosis")]
colnames(reduced_diagnosis_icd) <- c("PATIENT_ID", "Date", "Code", "Desc")

str(reduced_diagnosis_icd)

## Format ucpg table
#extract each icd rank and recombine them to one dataset
reduced_cpt_ucpg_1 <- cpt_ucpg[c("Patient_Id", "Date" = "Date_of_Service_DS", "ICD9_CM_CODE_1")]
colnames(reduced_cpt_ucpg_1) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_2 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_2")]
colnames(reduced_cpt_ucpg_2) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_3 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_3")]
colnames(reduced_cpt_ucpg_3) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_4 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_4")]
colnames(reduced_cpt_ucpg_4) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_5 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_5")]
colnames(reduced_cpt_ucpg_5) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_6 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_6")]
colnames(reduced_cpt_ucpg_6) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_7 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_7")]
colnames(reduced_cpt_ucpg_7) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_8 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_8")]
colnames(reduced_cpt_ucpg_8) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_9 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_9")]
colnames(reduced_cpt_ucpg_9) <- c("PATIENT_ID", "Date", "Code")

reduced_cpt_ucpg <- rbind(reduced_cpt_ucpg_1, reduced_cpt_ucpg_2, reduced_cpt_ucpg_3, reduced_cpt_ucpg_4, reduced_cpt_ucpg_5, reduced_cpt_ucpg_6, reduced_cpt_ucpg_7, reduced_cpt_ucpg_8, reduced_cpt_ucpg_9)

reduced_cpt_ucpg <- reduced_cpt_ucpg[!is.na(reduced_cpt_ucpg$Code),]

reduced_cpt_ucpg$Desc <- NA

##CHOOSE WHAT TABLES TO INCLUDE ---------------------------
modified_diagnosis_icd <- rbind(reduced_diagnosis_icd, reduced_cpt_ucpg)
#modified_diagnosis_icd <- reduced_diagnosis_icd

str(modified_diagnosis_icd)


#Change icd table so format of icd codes match HEDIS files
modified_diagnosis_icd$Code <- gsub("\\..*", "", modified_diagnosis_icd$Code) #remove any nubers after decimal point
modified_diagnosis_icd$Code <- str_pad(modified_diagnosis_icd$Code, 4, pad = "0") #pad so all codes are 4 characters long
modified_diagnosis_icd$Code <-as.factor(modified_diagnosis_icd$Code) #chanage to a factor

###  Join patient id table to diagnosis_icd table to bring in first Hep C date

pts_diagnosis <- inner_join(patients, modified_diagnosis_icd) #8,479,127 rows
dim(pts_diagnosis)
str(pts_diagnosis)

#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_diagnosis$BeforeorAfter <- ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code < pts_diagnosis$Date, "After", 
                                      ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code == pts_diagnosis$Date, "Same", "Before"))

#nrow(pts_diagnosis[(pts_diagnosis$ICD_TYPE == 9),])#7,961,673 rows
#nrow(pts_diagnosis[(pts_diagnosis$ICD_TYPE == 10),])#518,101 rows

#include observations that occurred before first Hep C diagnosis
pt_icd_codes <- pts_diagnosis[(pts_diagnosis$BeforeorAfter == "Before"),]

str(pt_icd_codes)


```



```{r}
##Join value set and pts_diagnosis code to identify value set name of each icd code
pt_icd_codes_value_sets <- inner_join(hep_c_project_HEDIS_icd_codes, pt_icd_codes)
dim(pt_icd_codes)
dim(hep_c_project_HEDIS_icd_codes)
dim(pt_icd_codes_value_sets)

##Evaluating join
#pt_icd_codes_value_sets[is.na(pt_icd_codes_value_sets$PATIENT_ID) & pt_icd_codes_value_sets$Code_System == "ICD9CM",]
#diagnosis_icd[grep("HIV", diagnosis_icd$icd_diagnosis),]

#Create table with frequency of icd codes
icd_freq_table <- as.data.frame.matrix(table(pt_icd_codes_value_sets$PATIENT_ID, pt_icd_codes_value_sets$Code))
str(icd_freq_table)

icd_freq_table$PATIENT_ID <- rownames(icd_freq_table)  #Create a column for PATIENT_ID
icd_freq_table <- icd_freq_table[c(57, 1:56)] #move PATIENT_ID column to columns 1
colnames(icd_freq_table)[2:57] <- paste("FREQ_ICD", colnames(icd_freq_table[,c(2:57)]), sep = "_")#rename column names to icd_code_freq for columns 2:56
rownames(icd_freq_table) <- NULL#Remove row names from data.frame

#join back with patients id's that were lost; 
patients <- left_join(patients, icd_freq_table)
str(patients)
names(patients)

# chanage NA's to zeros
patients[,10:65][is.na(patients[,10:65])] <- 0  
```

```{r}
###  CPT Tables #######

###  Prep procedure codes from HEDIS value sets

hep_c_project_HEDIS_procedure_codes <- subset(hep_c_project_HEDIS_value_sets, Code_System == "CPT" | Code_System == "ICD10PCS" | Code_System == "ICD9PCS" | Code_System ==  "HCPCS") #only Procedure codes only #383 codes

hep_c_project_HEDIS_procedure_codes$Code <- gsub("\\..*", "", hep_c_project_HEDIS_procedure_codes$Code) #drop the decimal point and any numbers after
hep_c_project_HEDIS_procedure_codes <- hep_c_project_HEDIS_procedure_codes[!duplicated(hep_c_project_HEDIS_procedure_codes$Code),] #remove duplicates codes;  #237 codes



####  COMBINE cpt, cpt_ucpg, and procedure icd table ###

#Join 3 tables with procedure codes; reduce tables to only patient_ID and CPT column and join the 3 tables together
reduced_procedure_icd <- procedure_icd[c("PATIENT_ID", "enc_dt_ds", "icd_px", "icd_procedure")]
colnames(reduced_procedure_icd) <- c("PATIENT_ID", "Date", "Code", "Desc")

reduced_cpt <- cpt[c("PATIENT_ID", "enc_dt_ds", "CPT", "CPT_Procedure")]
colnames(reduced_cpt) <- c("PATIENT_ID", "Date", "Code", "Desc") 

levels(reduced_procedure_icd$Code)

reduced_cpt_ucpg <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "CPT_Code")]
colnames(reduced_cpt_ucpg) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg$Desc <- NA

### CHOOSE WHICH TABLES TO USE BY REMVOING TABLES!!##
all_cpt <- rbind(reduced_procedure_icd, reduced_cpt, reduced_cpt_ucpg)

all_cpt$Code <- gsub("\\..*", "", all_cpt$Code) #drop the decimal point and any numbers after

str(all_cpt)



###  Join patient id table to all cpt table
pts_cpt <- inner_join(patients, all_cpt) 
dim(patients)
dim(all_cpt)
dim(pts_cpt)
str(pts_cpt)

#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_cpt$BeforeorAfter <-ifelse(is.na(pts_cpt$First_Date_with_Hep_C_ICD_code), "After",
                                        ifelse(pts_cpt$First_Date_with_Hep_C_ICD_code < pts_cpt$Date, "Same", "Before"))

#remove observations that occurred after Hep C diagnosis
pts_cpt <- pts_cpt[(pts_cpt$BeforeorAfter == "Before"),]

nrow(subset(pts_cpt, BeforeorAfter == "Before"))

#reduce file down to 2 columns - patient_id and procedure code
pt_cpt_codes <- pts_cpt[c("PATIENT_ID", "Code")]
str(pt_cpt_codes)


##Join value set and pts_cpt code to identify value set name of each icd code
pt_cpt_codes_value_sets <- inner_join(pt_cpt_codes, hep_c_project_HEDIS_procedure_codes)
dim(pt_cpt_codes)
dim(hep_c_project_HEDIS_procedure_codes)
dim(pt_cpt_codes_value_sets)


#Create table with frequency of icd codes
cpt_freq_table <- as.data.frame.matrix(table(pt_cpt_codes_value_sets$PATIENT_ID, pt_cpt_codes_value_sets$Code))
str(cpt_freq_table)

cpt_freq_table$PATIENT_ID <- rownames(cpt_freq_table) #Create a column for PATIENT_ID
cpt_freq_table <- cpt_freq_table[c(60, 1:59)]#move PATIENT_ID column to columns 1
rownames(cpt_freq_table) <- NULL#Remove row names from data.frame

#rename column names to icd_code_freq for columns 2:98
colnames(cpt_freq_table)[2:60] <- paste("FREQ_PROC", colnames(cpt_freq_table[,c(2:60)]), sep = "_")

#join back with all patients that were lost; 
patients <- left_join(patients, cpt_freq_table)
str(patients)


# chanage NA's to zeros
patients[,66:124][is.na(patients[,66:124])] <- 0

sum(is.na(patients))

```


```{r}
####  Encounter Variables ####

encounters_first_hep_c_encounter <- inner_join(encounters,patients)

##TRUE = Encounter was before first Hep C icd code
##FALSE = Encounter was NOT before first Hep C icd code
encounters_first_hep_c_encounter$before_diagnosis <- ifelse(encounters_first_hep_c_encounter$Enc_DT_DS < encounters_first_hep_c_encounter$First_Date_with_Hep_C_ICD_code, "TRUE", "FALSE") #Evaluate whether encounter was before or after first Hep C icd code date
encounters_first_hep_c_encounter <- encounters_first_hep_c_encounter[(encounters_first_hep_c_encounter$before_diagnosis=="TRUE"),] #Remove "False"


#Total_Num_Encounters
patient_ID_encounters<-data.frame(table(encounters_first_hep_c_encounter$PATIENT_ID))
colnames(patient_ID_encounters) <-  c("PATIENT_ID", "Total_Num_Encounters")
patients <- left_join(patients,patient_ID_encounters)
patients[,"Total_Num_Encounters"][is.na(patients[,"Total_Num_Encounters"])] <- 0

#Total_Num_Outpt_Visits
patient_ID_encounters_outpt <- data.frame(table(encounters_first_hep_c_encounter$PATIENT_ID[encounters_first_hep_c_encounter$Enc_EIO %in% c("O", "I, O", "E, O", "E, I, O")]))
colnames(patient_ID_encounters_outpt) <-  c("PATIENT_ID", "Total_Num_Outpt_Visits")
patients <- left_join(patients,patient_ID_encounters_outpt)
patients[,"Total_Num_Outpt_Visits"][is.na(patients[,"Total_Num_Outpt_Visits"])] <- 0

#Total_Num_Inpt_Admissions
patient_ID_encounters_inpt <- data.frame(table(encounters_first_hep_c_encounter$PATIENT_ID[encounters_first_hep_c_encounter$Enc_EIO %in% c("I", "I, O", "E, I, O", "E, I")]))
colnames(patient_ID_encounters_inpt) <-  c("PATIENT_ID", "Total_Num_Inpt_Admissions")
patients <- left_join(patients,patient_ID_encounters_inpt)
patients[,"Total_Num_Inpt_Admissions"][is.na(patients[,"Total_Num_Inpt_Admissions"])] <- 0

#Average_LOS_DAYS
average_LOS_Days <- aggregate(LOS_Days ~ PATIENT_ID, encounters_first_hep_c_encounter, mean, na.rm=TRUE)
average_LOS_Days$LOS_Days <- round(average_LOS_Days$LOS_Days, 2)
colnames(average_LOS_Days) <-  c("PATIENT_ID", "average_LOS_Days")
patients <- left_join(patients,average_LOS_Days)
patients[,"average_LOS_Days"][is.na(patients[,"average_LOS_Days"])] <- 0

#Total_Num_ED_Visits
patient_ID_encounters_ED <- data.frame(table(encounters_first_hep_c_encounter$PATIENT_ID[encounters_first_hep_c_encounter$Enc_EIO %in% c("E, I", "E", "E, I, O", "E, O")]))
colnames(patient_ID_encounters_ED) <-  c("PATIENT_ID", "Total_Num_ED_Visits")
patients <- left_join(patients,patient_ID_encounters_ED)
patients[,"Total_Num_ED_Visits"][is.na(patients[,"Total_Num_ED_Visits"])] <- 0

##Insurance_Aided - Did the patient ever recieve aid to cover medical bills?  
#TRUE = Fin Class listed "Charity", "Grants & Funds" or "medicaid" at least once in medical history
#FALSE = Fin Class wasd NEVER listed as "Charity", "Grants & Funds" or "medicaid"; no record in Fin Class is FALSE - should it be changed to unknown?

levels(encounters_first_hep_c_encounter$Fin_Class) <- c("Insured", "Insured", "Aided", "Aided", "Insured", 
                                                        "Insured", "Aided", "Insured", "Insured", "Insured", 
                                                        "Insured", "Insured", "Insured", "Aided", "Aided", 
                                                        "Aided", "Aided", "Insured", "Insured", "Insured",
                                                        "Insured", "Insured", "Self Pay", "Self Pay")
#Changed levels
#Insured = combines any commerical insurance plans and Medicare 
#Aided = combines Charity, Grants & Funds, Medicaid
#Self payy = self pay

patient_ID_insurance_aided <- data.frame(table(encounters_first_hep_c_encounter$PATIENT_ID[encounters_first_hep_c_encounter$Fin_Class == "Aided"]))
colnames(patient_ID_insurance_aided) <-  c("PATIENT_ID", "InsuranceAidedCt")
patient_ID_insurance_aided[,"InsuranceAidedCt"][is.na(patient_ID_insurance_aided[,"InsuranceAidedCt"])] <- 0

patient_ID_insurance_aided$Insurance_Aided <- ifelse(patient_ID_insurance_aided$InsuranceAidedCt>0,"TRUE", "FALSE")
patient_ID_insurance_aided <- patient_ID_insurance_aided[, c(1,3)] #remove count variable
patients <- left_join(patients, patient_ID_insurance_aided)
patients[,"Insurance_Aided"][is.na(patients[,"Insurance_Aided"])] <- "FALSE"
patients$Insurance_Aided <- as.factor(patients$Insurance_Aided)


#Insurance_Gap - Was there a ever a NA or self Pay listed as Fin Class?
##TRUE = a NA or self pay was listed at least once?
##FALSE = a insurance policy was always listed?  might want to include charity or grant funded????
### ??????????  Lots of pts have a NA listed on encounters???  will some encounters type not list insurance list?
patient_ID_insurancegap <- data.frame(table(encounters_first_hep_c_encounter$PATIENT_ID[(is.na(encounters_first_hep_c_encounter$Fin_Class)| encounters_first_hep_c_encounter$Fin_Class == "Self Pay")]))
colnames(patient_ID_insurancegap) <-  c("PATIENT_ID", "InsuranceGapCt")

patient_ID_insurancegap$Insurance_Gap <- ifelse(patient_ID_insurancegap$InsuranceGap>0,"TRUE", "FALSE")
patient_ID_insurancegap <- patient_ID_insurancegap[, c(1,3)] #remove count variable
patients <- left_join(patients, patient_ID_insurancegap)
patients[,"Insurance_Gap"][is.na(patients[,"Insurance_Gap"])] <- "FALSE"
patients$Insurance_Gap <- as.factor(patients$Insurance_Gap)

str(patients)

sum(is.na(patients))

```

```{r}
#####  American Community survey Data ######

####  Finding Most Frequent zip Codes ###
#Zip_Code
#encounters_minus_NAzips <- encounters_first_hep_c_encounter[!is.na(encounters_first_hep_c_encounter$Zip_Code_DID),] #remove obserevations with NA's
#encounters_minus_NAzips <- encounters_minus_NAzips[,c("PATIENT_ID", "Zip_Code_DID")] #eliminate other variables in the encounters to speed things up
#encounters_minus_NAzips$Zip_Code_DID <- as.factor(encounters_minus_NAzips$Zip_Code_DID) #make it into a factor

#zip_code_freq_table <- as.data.frame.matrix(table(encounters_minus_NAzips$PATIENT_ID, encounters_minus_NAzips$Zip_Code_DID)) #create table with patient_ID's as rowns and zip codes as column
#str(zip_code_freq_table) 

#zip_code_freq_table$Most_Freq_Zip <- colnames(zip_code_freq_table)[apply(zip_code_freq_table, 1,which.max)]#creating a new column that gives which column has the highest value; ties goes to the lowest index 

#pts_zip_ACS <- zip_code_freq_table[,c(1,6778)] #reduce columns
#pts_zip_ACS$PATIENT_ID <- rownames(pts_zip_ACS) #Create a column for PATIENT_ID
#pts_zip_ACS <- pts_zip_ACS[c(3, 2)]#move PATIENT_ID column to columns 1
#rownames(pts_zip_ACS) <- NULL#Remove row names from data.frame


##Import Zip Code assignment file
zip_updates<-read_delim("Z:/ZipReassignmentForR_081317.csv", ",", escape_double = FALSE, trim_ws = TRUE)
str(zip_updates)
zip_updates$PATIENT_ID<-as.character(zip_updates$PATIENT_ID) 
zip_updates$PATIENT_ID<-str_pad(zip_updates$PATIENT_ID, 10, pad = "0")
zip_updates$Most_Freq_Zip<-as.character(zip_updates$NewZip) 


pts_zip_ACS <- left_join(zip_updates, ACS, c("Most_Freq_Zip" = "Zip_Code_DID")) #add ACS by matching on zip code; 954 zip codes unmatched???
dim(zip_updates)
dim(pts_zip_ACS)
sum(is.na(pts_zip_ACS))
sum(is.na(pts_zip_ACS$Most_Freq_Zip))
sum(is.na(pts_zip_ACS$Pct_No_Health_Insurance))
str(pts_zip_ACS)


patients <- left_join(patients, pts_zip_ACS) #join with other patient variables
dim(pts_zip_ACS)
dim(patients)
sum(is.na(patients$Most_Freq_Zip))  #0 NA's - no zip code
sum(is.na(patients$Pct_No_Health_Insurance)) #5 NA's - no ACS data

str(patients[,1:75])
str(patients[,76:150])
str(patients[,151:175])

names(patients)
#remove zip code column
patients <- patients[-c(132:133)]

#remove NA's
patients[,132:173][is.na(patients[,132:173])] <- 0 
sum(is.na(patients))
```


```{r}

#####  Social History Variables ####

#merge patient id's with social history table

dim(social_hx)
dim(patients)
pts_social <- left_join(patients, social_hx) #add demographics
dim(pts_social)

str(pts_social)
pts_social<-pts_social[order(pts_social$PATIENT_ID),]

#remove observations after First_Date_with_Hep_C_ICD_code; also removes observations where the Enc_DT_DS is blank because we are not able ot determine when the social survey was taken.
pts_social$BeforeorAfter <-ifelse(pts_social$First_Date_with_Hep_C_ICD_code=="9999-12-31", 1,
                                        ifelse(pts_social$First_Date_with_Hep_C_ICD_code < pts_social$Enc_DT_DS, 0, 1))

nrow(subset(pts_social, BeforeorAfter == 0))
nrow(subset(pts_social, BeforeorAfter == 1))

pts_social <- subset(pts_social, BeforeorAfter == 1)
#old_rows<-nrow(pts_social[1])
#remove duplicated rows - no duplicates present
#pts_social <- pts_social[!duplicated(pts_social),]
#new_rows<-nrow(pts_social)
#rows_deleted<-old_rows-new_rows; rows_deleted


##### Tobacco ####

###Convert all of these to Ever/Never/No Data = 2/1/0
#TOBACCO_USER
#SMOKING_TOB_USE
#SMOKELESS_TOB_USE
#CIGARETTES_YN
#PIPES_YN
#CIGARS_YN
#SNUFF_YN
#CHEW_YN

#then check if any of then have ever been answered with "2" before and mark the TOBACCO_USER_DER variable "Ever" if they have


#Recoding the TOBACCO_USER status variable -
#NA = 0
#0 = "Not Asked"
#1 = "Never"
#1 = "Passive"
#2 = "Quit"
#2 = "Yes"
pts_social$TOBACCO_USER_FCR<-pts_social$TOBACCO_USER
levels(pts_social$TOBACCO_USER_FCR) <- c("1", "0", "1", "2", "2")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$TOBACCO_USER_FCR[is.na(pts_social$TOBACCO_USER_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$TOBACCO_USER_FCR,pts_social$TOBACCO_USER)
pts_social$TOBACCO_USER_FCR <- as.numeric(as.character(pts_social$TOBACCO_USER_FCR))

#Recoding the SMOKING_TOB_USE status variable 

#2 - Current Every Day Smoker               
#2 - Current Some Day Smoker 
#2 - Former Smoker
#2 - Heavy Tobacco Smoker
#2 - Light Tobacco Smoker
#0 - Never Assessed
#1 - Never Smoker 
#1 - Passive Smoke Exposure - Never Smoker
#2 - Smoker, Current Status Unknown
#0 - Unknown If Ever Smoked


pts_social$SMOKING_TOB_USE_FCR<-pts_social$SMOKING_TOB_USE
levels(pts_social$SMOKING_TOB_USE_FCR) <- c("2", "2", "2", "2", "2", "0","1","1","0","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$SMOKING_TOB_USE_FCR[is.na(pts_social$SMOKING_TOB_USE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$SMOKING_TOB_USE_FCR)
pts_social$SMOKING_TOB_USE_FCR <- as.numeric(as.character(pts_social$SMOKING_TOB_USE_FCR))


#Recoding the SMOKELESS_TOB_USE status variable 
#2 - Current User
#2 - Former User
#1 - Never Used
#0 - Unknown
#Yes - 2

pts_social$SMOKELESS_TOB_USE_FCR<-pts_social$SMOKELESS_TOB_USE
levels(pts_social$SMOKELESS_TOB_USE_FCR) <- c("2", "2", "1", "0","2")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$SMOKELESS_TOB_USE_FCR[is.na(pts_social$SMOKELESS_TOB_USE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$SMOKELESS_TOB_USE_FCR)
pts_social$SMOKELESS_TOB_USE_FCR <- as.numeric(as.character(pts_social$SMOKELESS_TOB_USE_FCR))


#Recoding the CIGARETTES_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$CIGARETTES_YN_FCR<-pts_social$CIGARETTES_YN
levels(pts_social$CIGARETTES_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$CIGARETTES_YN_FCR[is.na(pts_social$CIGARETTES_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$CIGARETTES_YN_FCR)
pts_social$CIGARETTES_YN_FCR <- as.numeric(as.character(pts_social$CIGARETTES_YN_FCR))


#Recoding the PIPES_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$PIPES_YN_FCR<-pts_social$PIPES_YN
levels(pts_social$PIPES_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$PIPES_YN_FCR[is.na(pts_social$PIPES_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$PIPES_YN_FCR)
pts_social$PIPES_YN_FCR <- as.numeric(as.character(pts_social$PIPES_YN_FCR))


#Recoding the CIGARS_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$CIGARS_YN_FCR<-pts_social$CIGARS_YN
levels(pts_social$CIGARS_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$CIGARS_YN_FCR[is.na(pts_social$CIGARS_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$CIGARS_YN_FCR)
pts_social$CIGARS_YN_FCR <- as.numeric(as.character(pts_social$CIGARS_YN_FCR))


#Recoding the SNUFF_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$SNUFF_YN_FCR<-pts_social$SNUFF_YN
levels(pts_social$SNUFF_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$SNUFF_YN_FCR[is.na(pts_social$SNUFF_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$SNUFF_YN_FCR)
pts_social$SNUFF_YN_FCR <- as.numeric(as.character(pts_social$SNUFF_YN_FCR))


#Recoding the CHEW_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$CHEW_YN_FCR<-pts_social$CHEW_YN
levels(pts_social$CHEW_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$CHEW_YN_FCR[is.na(pts_social$CHEW_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$CHEW_YN_FCR)
pts_social$CHEW_YN_FCR <- as.numeric(as.character(pts_social$CHEW_YN_FCR))


### create extra variable that takes the max of the other tobacco-related variaables. If the person has ever marked Y on any of them, consider the "smoker"
#TOBACCO_USER
#SMOKING_TOB_USE
#SMOKELESS_TOB_USE
#CIGARETTES_YN
#PIPES_YN
#CIGARS_YN
#SNUFF_YN
#CHEW_YN

pts_social$TOBACCO_USER_STATUS_DER_ENC<-as.numeric("0")

i <-1
cols<-ncol(pts_social)
rows<-nrow(pts_social)
initial_time<-Sys.time()
while (i<=rows){
  ifelse(pts_social[i,(cols-8)]==0 & pts_social[i,(cols-7)]==0 & pts_social[i,(cols-6)]==0 & pts_social[i,(cols-5)]==0& pts_social[i,(cols-4)]==0& pts_social[i,(cols-3)] ==0 & pts_social[i,(cols-2)]==0 & pts_social[i,(cols-1)]==0, 0,  pts_social[i,cols]<- max(pts_social[i,(cols-8):(cols-1)]))
  i=i+1
  print(c("percent done ",i/rows))
  final_time<-Sys.time()
  }
final_time-initial_time          

#pts_social[60:150,66:74]



#find max status of tobacco_user
#change formatting of object to factor
pts_max_status <- aggregate(TOBACCO_USER_STATUS_DER_ENC~PATIENT_ID,  data = pts_social, max)
colnames(pts_max_status) <- c("PATIENT_ID", "TOBACCO_USER_STATUS_DER")
pts_max_status$TOBACCO_USER_STATUS_DER<-as.factor(pts_max_status$TOBACCO_USER_STATUS_DER)
levels(pts_max_status$TOBACCO_USER_STATUS_DER) <- c("Unknown", "Never", "Ever")
#head(pts_max_status)
dim(pts_max_status)
str(pts_max_status)
table(pts_max_status$TOBACCO_USER_STATUS_DER)


#Add the variable to the patients table
patients<-left_join(patients,pts_max_status, by = "PATIENT_ID")
patients$TOBACCO_USER_STATUS_DER[is.na(patients$TOBACCO_USER_STATUS_DER)] <- "Unknown"


### Intentsity of tobacco use
pts_max_packs<-aggregate(TOBACCO_PAK_PER_DY~PATIENT_ID, data = pts_social,max)
colnames(pts_max_packs) <- c("PATIENT_ID", "TOBACCO_PAK_PER_DAY")
patients<-left_join(patients,pts_max_packs, by = "PATIENT_ID")
patients$TOBACCO_PAK_PER_DAY[is.na(patients$TOBACCO_PAK_PER_DAY)] <- 0


pts_social<-pts_social[order(-pts_social$TOBACCO_USER_STATUS_DER_ENC,pts_social$PATIENT_ID),]
#validate<-pts_social[,c(1:3,17,18,20,21,74)]


# number of years smoked
pts_max_years<-aggregate(TOBACCO_USED_YEARS~PATIENT_ID, data = pts_social,max)
colnames(pts_max_years) <- c("PATIENT_ID", "TOBACCO_USED_YEARS")
patients<-left_join(patients,pts_max_years, by = "PATIENT_ID")
patients$TOBACCO_USED_YEARS[is.na(patients$TOBACCO_USED_YEARS)] <- 0
patients<-patients[,c(-6,-7)]



##### Alcohol ####
#alcohol related fields: 
#ALCOHOL_USE_C
#ALCOHOL_USE
#HX_DRINK_TYPES_C
#HX_DRINK_TYPES - not using -using alcohol use instead
#ALCOHOL_DRINKS_WK - data quality poor - field mostly blank
#ALCOHOL_OZ_PER_WK
#ALCOHOL_COMMENT

#Recoding the ALCOHOL_USE status variable -
#1 - No
#0 - Not Asked
#2 - Yes

pts_social$ALCOHOL_USE_FCR<-pts_social$ALCOHOL_USE
levels(pts_social$ALCOHOL_USE_FCR) <- c("1", "1","0", "2")
#nrow(subset(pts_social,is.na(ALCOHOL_USE_FCR)=="TRUE"))
pts_social$ALCOHOL_USE_FCR[is.na(pts_social$ALCOHOL_USE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(ALCOHOL_USE_FCR)=="TRUE"))
table(pts_social$ALCOHOL_USE_FCR)
pts_social$ALCOHOL_USE_FCR <- as.numeric(as.character(pts_social$ALCOHOL_USE_FCR))

#alcohol usage
pts_max_alc_use<-aggregate(ALCOHOL_USE_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_alc_use) <- c("PATIENT_ID", "ALCOHOL_USE_FCR")
patients<-left_join(patients,pts_max_alc_use, by = "PATIENT_ID")
patients$ALCOHOL_USE_FCR[is.na(patients$ALCOHOL_USE_FCR)] <- 0


## Alcohol intensiy - ALCOHOL_OZ_PER_WK
pts_social$ALCOHOL_OZ_PER_WK_FCR<-pts_social$ALCOHOL_OZ_PER_WK
pts_social$ALCOHOL_OZ_PER_WK_FCR[is.na(pts_social$ALCOHOL_OZ_PER_WK_FCR)] <- 0
pts_max_alc_oz<-aggregate(ALCOHOL_OZ_PER_WK_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_alc_oz) <- c("PATIENT_ID", "ALCOHOL_OZ_PER_WK_FCR")
patients<-left_join(patients,pts_max_alc_oz, by = "PATIENT_ID")
patients$ALCOHOL_OZ_PER_WK_FCR[is.na(patients$ALCOHOL_OZ_PER_WK_FCR)] <- 0



#### Sexual behavior ########

#Recoding the SEXUALLY_ACTIVE status variable -
#1 - No
#0 - Not Asked
#2 - Not Currently
#2 - Yes

pts_social$SEXUALLY_ACTIVE_FCR<-pts_social$SEXUALLY_ACTIVE
levels(pts_social$SEXUALLY_ACTIVE_FCR) <- c("1", "1", "0", "2","2")
#nrow(subset(pts_social,is.na(SEXUALLY_ACTIVE_FCR)=="TRUE"))
pts_social$SEXUALLY_ACTIVE_FCR[is.na(pts_social$SEXUALLY_ACTIVE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(SEXUALLY_ACTIVE_FCR)=="TRUE"))
table(pts_social$SEXUALLY_ACTIVE_FCR)
pts_social$SEXUALLY_ACTIVE_FCR <- as.numeric(as.character(pts_social$SEXUALLY_ACTIVE_FCR))

#aggregate sexual activity to patient level
pts_max_sex_active<-aggregate(SEXUALLY_ACTIVE_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_sex_active) <- c("PATIENT_ID", "SEXUALLY_ACTIVE_FCR")
patients<-left_join(patients,pts_max_sex_active, by = "PATIENT_ID")
patients$SEXUALLY_ACTIVE_FCR[is.na(patients$SEXUALLY_ACTIVE_FCR)] <- 0

#Recoding the SEX_ENC_TYPE - type of sexual encounter. If the patient has ever had homosexual activity. 
#bring in the demographics table
pts_social<-left_join(pts_social,demo, by = "PATIENT_ID")

#Replace "NA" with U = unknown gender for the patient themselves
nrow(subset(pts_social,is.na(Gender)=="TRUE"))
pts_social$Gender[is.na(pts_social$Gender)] <- "U"
nrow(subset(pts_social,is.na(Gender)=="TRUE"))

#Clean data for the patients partner - Female partner
levels(pts_social$FEMALE_PARTNER_YN) <- c("N", "Y", "U")
nrow(subset(pts_social,is.na(FEMALE_PARTNER_YN)=="TRUE"))
pts_social$FEMALE_PARTNER_YN[is.na(pts_social$FEMALE_PARTNER_YN)] <- "U"
nrow(subset(pts_social,is.na(FEMALE_PARTNER_YN)=="TRUE"))

#Clean data for the patients partner - Male partner
levels(pts_social$MALE_PARTNER_YN) <- c("N", "Y", "U")
nrow(subset(pts_social,is.na(MALE_PARTNER_YN)=="TRUE"))
pts_social$MALE_PARTNER_YN[is.na(pts_social$MALE_PARTNER_YN)] <- "U"
nrow(subset(pts_social,is.na(MALE_PARTNER_YN)=="TRUE"))

#claculate if the the encounter was homosexual, heterosexual or Unknown
pts_social$Sex_Partner_Gender<-ifelse(pts_social$FEMALE_PARTNER_YN=="Y",ifelse(pts_social$MALE_PARTNER_YN=="Y","Mix","F"),ifelse(pts_social$MALE_PARTNER_YN=="Y","M","U"))
pts_social$sex_enc_type<-ifelse(pts_social$Gender=="U" | pts_social$Sex_Partner_Gender=="U","U",ifelse(pts_social$Sex_Partner_Gender=="Mix","HO",ifelse(pts_social$Gender==pts_social$Sex_Partner_Gender,"HO","HE")))
pts_social[100:200,c(1,75,40,41,86,87)]

#aggregate and bring into patients table
#if any homosexual axtivity has been recorded in the past, this variable is flagged HO.
pts_max_sex_enc_type<-aggregate(sex_enc_type~PATIENT_ID, data = pts_social,max)
colnames(pts_max_sex_enc_type) <- c("PATIENT_ID", "SEX_ENC_TYPE")
patients<-left_join(patients,pts_max_sex_enc_type, by = "PATIENT_ID")
patients$SEX_ENC_TYPE[is.na(patients$SEX_ENC_TYPE)] <- "U"
patients$SEX_ENC_TYPE<-as.factor(patients$SEX_ENC_TYPE)

#### Condom use
# y = 2
# N = 1
#n/a = 0

pts_social$CONDOM_YN_FCR<-pts_social$CONDOM_YN
levels(pts_social$CONDOM_YN_FCR) <- c("2","1", "2")
nrow(subset(pts_social,is.na(CONDOM_YN_FCR)=="TRUE"))
pts_social$CONDOM_YN_FCR <- as.numeric(as.character(pts_social$CONDOM_YN_FCR))
pts_social$CONDOM_YN_FCR[is.na(pts_social$CONDOM_YN_FCR)] <- "0"
nrow(subset(pts_social,is.na(CONDOM_YN_FCR)=="TRUE"))
pts_social$CONDOM_YN_FCR <- as.numeric(as.character(pts_social$CONDOM_YN_FCR))
table(pts_social$CONDOM_YN_FCR)


#aggregate sexual activity to patient level
pts_max_condom_use<-aggregate(CONDOM_YN_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_sex_active) <- c("PATIENT_ID", "CONDOM_YN_FCR")
patients<-left_join(patients,pts_max_sex_active, by = "PATIENT_ID")
patients$CONDOM_YN_FCR[is.na(patients$CONDOM_YN_FCR)] <- 0


##### Occupation#####
#the occupation field is mostly blank - build 2 factors: NA and everything else
pts_social$OCCUPATION_FCR<-pts_social$OCCUPATION

#pts_social$OCCUPATION_FCR[is.na(pts_social$OCCUPATION_FCR)] <- "0"

occupations<-data.frame(table(pts_social$OCCUPATION))


```

```{r}
#####  Double Check flat File & Export

sum(is.na(patients))  # should be zero NA's
#26258
dim(patients)  #232661   179
str(patients)
names(patients)


write.csv(patients, "Z:/Flat File/patients_HEDIS_20170816file.csv")
```

```{r}

### CCS categories ####

###  Import CCS  9 categories  ####

ccs_9 <- read.csv("Z:/Value Sets/CCSCategoryNames_ICD9.csv", header = TRUE, stringsAsFactor = FALSE)

#Formatting CCS file
ccs_9$X.ICD.9.CM.CODE. <- sub(".$", "", ccs_9$X.ICD.9.CM.CODE.)#remove last character in string
ccs_9$X.ICD.9.CM.CODE. <- sub("^.", "", ccs_9$X.ICD.9.CM.CODE.)#remove first character in string

ccs_9$X.ICD.9.CM.CODE. <- trimws(ccs_9$X.ICD.9.CM.CODE., which = c("right")) #remove extra spaces
ccs_9$X.ICD.9.CM.CODE. <- str_pad(ccs_9$X.ICD.9.CM.CODE., 5, "right", pad = "0") #add zeros at the end

ccs_9 <- ccs_9 [c("X.ICD.9.CM.CODE.",  "CCS.CATEGORY", "X.CCS.CATEGORY.DESCRIPTION.")]
colnames(ccs_9) <- c("Code", "CCS_CATEGORY", "CCS_DESC")
ccs_9 <- ccs_9[!duplicated(ccs_9$Code),]
str(ccs_9)

###  Import CCS  10 categories  ####

ccs_10 <- read.csv("Z:/Value Sets/ccs_dx_icd10cm_2017.csv", header = TRUE, stringsAsFactor = FALSE)

#Formatting CCS file
ccs_10$X.ICD.10.CM.CODE. <- sub(".$", "", ccs_10$X.ICD.10.CM.CODE.)#remove last character in string
ccs_10$X.ICD.10.CM.CODE. <- sub("^.", "", ccs_10$X.ICD.10.CM.CODE.)#remove first character in string

ccs_10$X.CCS.CATEGORY. <- sub(".$", "", ccs_10$X.CCS.CATEGORY.)#remove last character in string
ccs_10$X.CCS.CATEGORY. <- sub("^.", "", ccs_10$X.CCS.CATEGORY.)#remove first character in string

ccs_10 <- ccs_10 [c("X.ICD.10.CM.CODE.",  "X.CCS.CATEGORY.", "X.CCS.CATEGORY.DESCRIPTION.")]
colnames(ccs_10) <- c("Code", "CCS_CATEGORY", "CCS_DESC")
str(ccs_10)
```



```{r}
#### icd Diagnosis table - ICD Codes ####
#### Map ICD codes to CCS categories  ###########

reduced_diagnosis_icd <- diagnosis_icd[c("PATIENT_ID", "enc_dt_ds", "icd_dx", "ICD_TYPE", "icd_diagnosis")]
colnames(reduced_diagnosis_icd) <- c("PATIENT_ID", "Date", "Code", "Type", "Desc")

### ICD 9 ###
reduced_diagnosis_icd_9 <- subset(reduced_diagnosis_icd, Type == "9") #8,016,285
reduced_diagnosis_icd_9 <- reduced_diagnosis_icd_9[,-4]

reduced_diagnosis_icd_9$Code <- gsub("\\.", "", reduced_diagnosis_icd_9$Code) #remove decimal point
reduced_diagnosis_icd_9$Code <- str_pad(reduced_diagnosis_icd_9$Code, 5, "right", pad = "0") #pad so all codes are 4 characters long

#join icd 9 codes from diagnosis table to ccs categories
icd_9_codes_ccs <- inner_join(reduced_diagnosis_icd_9, ccs_9)
dim(icd_9_codes_ccs) #8,016,284
dim(reduced_diagnosis_icd_9)  #8,016,285
dim(ccs_9)  #14800

### ICD 10 ###
reduced_diagnosis_icd_10 <- subset(reduced_diagnosis_icd, Type == "10") #520,609
reduced_diagnosis_icd_10 <- reduced_diagnosis_icd_10[,-4]

#join icd 10 codes from diagnosis table to ccs categories
icd_10_codes_ccs <- inner_join(reduced_diagnosis_icd_10, ccs_10)
dim(icd_10_codes_ccs) #512,891
dim(reduced_diagnosis_icd_10) #520,609
dim(ccs_10) #71807

icd_codes_css <- rbind(icd_9_codes_ccs, icd_10_codes_ccs)
str(icd_codes_css)

```


```{r}
## Format ucpg table
#extract each icd rank and recombine them to one dataset

#reduced_cpt_ucpg_1 <- cpt_ucpg[c("PATIENT_ID", "Date" = "Date_of_Service_DS", "ICD9_CM_CODE_1")]
#colnames(reduced_cpt_ucpg_1) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_2 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_2")]
#colnames(reduced_cpt_ucpg_2) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_3 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_3")]
#colnames(reduced_cpt_ucpg_3) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_4 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_4")]
#colnames(reduced_cpt_ucpg_4) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_5 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_5")]
#colnames(reduced_cpt_ucpg_5) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_6 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_6")]
#colnames(reduced_cpt_ucpg_6) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_7 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_7")]
#colnames(reduced_cpt_ucpg_7) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_8 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_8")]
#colnames(reduced_cpt_ucpg_8) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_9 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_9")]
#colnames(reduced_cpt_ucpg_9) <- c("PATIENT_ID", "Date", "Code")

#reduced_cpt_ucpg <- rbind(reduced_cpt_ucpg_1, reduced_cpt_ucpg_2, reduced_cpt_ucpg_3, reduced_cpt_ucpg_4, reduced_cpt_ucpg_5, reduced_cpt_ucpg_6, reduced_cpt_ucpg_7, reduced_cpt_ucpg_8, reduced_cpt_ucpg_9)

#reduced_cpt_ucpg <- reduced_cpt_ucpg[!is.na(reduced_cpt_ucpg$Code),]

#reduced_cpt_ucpg$Code <- gsub("\\.", "", reduced_cpt_ucpg$Code) #remove decimal point
#reduced_cpt_ucpg$Code <- str_pad(reduced_cpt_ucpg$Code, 5, "right", pad = "0") #pad so all codes are 4 characters long
#modified_diagnosis_icd$Code <-as.factor(modified_diagnosis_icd$Code) #chanage to a factor

#cpt_ucpg_codes_css <- left_join(reduced_cpt_ucpg, ccs)
#dim(cpt_ucpg_codes_css)
#dim(join)
#dim(ccs)

##evaluatign join
#sum(is.na(join$CCS_CATEGORY))  #26812 = na's for 9; #369552 = na's for 10

##Add icd codes from cpt_ucpg table to diagnosis table
#icd_codes_css <- rbind(icd_codes_css, reduced_cpt_ucpg)
#str(icd_codes_css)
```

```{r}
## Reduce icd codes with ccs catgories to only patients in our cohort ###
pts_diagnosis <- inner_join(patients, icd_codes_css) 
dim(pts_diagnosis) #8,456,100
dim(patients) #283,661
dim(icd_codes_css) #8,529,175 


#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_diagnosis$BeforeorAfter <- ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code < pts_diagnosis$Date, "After", 
                                      ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code == pts_diagnosis$Date, "Same", "Before"))

#include observations that occurred before first Hep C diagnosis only
pts_diagnosis <- pts_diagnosis[(pts_diagnosis$BeforeorAfter == "Before"),] #8,099,653
str(pts_diagnosis) #8,232,623



#Create table with frequency of ccs categories
ccs_freq_table <- as.data.frame.matrix(table(pts_diagnosis$PATIENT_ID, pts_diagnosis$CCS_CATEGORY))
str(ccs_freq_table)

ccs_freq_table$PATIENT_ID <- rownames(ccs_freq_table)  #Create a column for PATIENT_ID
ccs_freq_table <- ccs_freq_table[c(282, 1:281)] #move PATIENT_ID column to columns 1
colnames(ccs_freq_table)[2:282] <- paste("FREQ_ICD_CCS", colnames(ccs_freq_table[,c(2:282)]), sep = "_")#rename column names to icd_code_freq for columns 2:282
rownames(ccs_freq_table) <- NULL#Remove row names from data.frame


#join back with patients id's that were lost; 
patients <- left_join(patients, ccs_freq_table)
str(patients)

# chanage NA's to zeros
patients[,180:460][is.na(patients[,180:460])] <- 0  

sum(is.na(patients))

#Demographic variables = 4-7
#ICD codes grouped by HEDIS value sets = 8-63
#CPT codes by HEDIS value sets = 64-122
#Encounter variables = 123-129
#ACS variables = 130-171
#Social variables = 172-179
#ICD grouped by CCS variables = 180-460
```

```{r}
#####  Double Check flat File & Export

sum(is.na(patients))  # should be zero NA's

dim(patients)  #232661   460
str(patients)
names(patients)


write.csv(patients, "Z:/Flat File/patients_HEDIS_and_CCS_20170816file.csv")
```

```{r}

######  STOP #####
###  NOT FINISHED ####



### CCS categories ####

###  Import CCS CPT categories  ####

cpt_CCS <- read.csv("Z:/Value Sets/2017_ccs_services_procedures.csv", header = TRUE, stringsAsFactor = FALSE)

#Formatting CCS file
cpt_CCS$Code.Range <- sub(".$", "", cpt_CCS$Code.Range)#remove last character in string
cpt_CCS$Code.Range <- sub("^.", "", cpt_CCS$Code.Range)#remove first character in string

cpt_CCS$Code.Range <- trimws(cpt_CCS$Code.Range, which = c("right")) #remove extra spaces
#cpt_CCS$Code.Range <- str_pad(cpt_CCS$Code.Range, 5, "right", pad = "0") #add zeros at the end

code_ranges <- strsplit(as.character(cpt_CCS$Code.Range), "-", fixed = TRUE)
cpt_CCS$Code.Range_1 <- sapply(code_ranges, "[", 1)
cpt_CCS$Code.Range_2 <- sapply(code_ranges, "[", 2)

cpt_CCS <- cpt_CCS [c("X.ICD.9.CM.CODE.",  "CCS.CATEGORY", "X.CCS.CATEGORY.DESCRIPTION.")]
colnames(cpt_CCS) <- c("Code", "CCS_CATEGORY", "CCS_DESC")

str(cpt_CCS)




```
```{r}
####  COMBINE codes from cpt and cpt_ucpg ###

reduced_cpt <- cpt[c("PATIENT_ID", "enc_dt_ds", "CPT", "CPT_Procedure", "QUANTITY")]
colnames(reduced_cpt) <- c("PATIENT_ID", "Date", "Code", "Desc", "Quantity") 
reduced_cpt$Code <- as.character(reduced_cpt$Code)

sort(reduced_cpt$Code, decreasing = FALSE)

#reduced_cpt_ucpg <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "CPT_Code")]
#colnames(reduced_cpt_ucpg) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg$Desc <- NA

### CHOOSE WHICH TABLES TO USE BY REMVOING TABLES!!##
#all_cpt <- rbind(reduced_cpt, reduced_cpt_ucpg)
all_cpt <- reduced_cpt
str(all_cpt)


#join cpt codes to ccs categories
cpt_codes_ccs <- left_join(all_cpt, cpt_CCS, by = c("Code" = "Code.Range_2"))
dim(cpt_codes_ccs)
dim(all_cpt)
dim(cpt_CCS)

all_cpt <- ifelse(all_cpt)
str(cpt_codes_ccs)

sum(is.na(cpt_codes_ccs$CCS))

subset(cpt_codes_ccs, !(is.na(CCS)))