---
title: "capstone_variablecreation"
author: "Laura Olson"
date: "May 20, 2017"
output: html_document
---
```{r}

library(dplyr)
```

```{r}
################### Creating an Unique Patient ID List - Combine Patient ID's from all tables ############


pt_ID_encounters <- encounters %>% distinct(PATIENT_ID)

pt_ID_diagnosis_icd <- diagnosis_icd %>% distinct(PATIENT_ID)

str(pt_ID_diagnosis_icd)

#Join encounter and diagnosis patient id's

join_ID_1 <- full_join(pt_ID_encounters, pt_ID_diagnosis_icd)

#double check join
sum(is.na(join_ID_1))
dim(pt_ID_encounters)
dim(pt_ID_diagnosis_icd)
dim(join_ID_1)
nrow(join_ID_1 %>% distinct(PATIENT_ID))


#Add in patient id's in CPT code
pt_ID_cpt <- cpt %>% distinct(PATIENT_ID)
join_ID_2 <- full_join(join_ID_1, pt_ID_cpt)

#double check join
sum(is.na(join_ID_2))
dim(join_ID_1)
dim(pt_ID_cpt)
dim(join_ID_2)
nrow(join_ID_2 %>% distinct(PATIENT_ID))


#Add in patient id's in med rec admission table
pt_ID_med_rec_adm <- med_rec_adm %>% distinct(PATIENT_ID)
join_ID_3 <- full_join(join_ID_2, pt_ID_med_rec_adm)

#double check join
sum(is.na(join_ID_3))
dim(join_ID_2)
dim(pt_ID_med_rec_adm)
dim(join_ID_3)
nrow(join_ID_3 %>% distinct(PATIENT_ID))


#Add in patient id's in med rec discharge table
pt_ID_med_rec_dc <- med_rec_dc %>% distinct(PATIENT_ID)
join_ID_4 <- full_join(join_ID_3, pt_ID_med_rec_dc)

#double check join
sum(is.na(join_ID_4))
dim(join_ID_3)
dim(pt_ID_med_rec_dc)
dim(join_ID_4)
nrow(join_ID_4 %>% distinct(PATIENT_ID))


#Add in patient id's in med inpatient table
pt_ID_meds_inpt <- meds_inpt %>% distinct(PATIENT_ID)
join_ID_5 <- full_join(join_ID_4, pt_ID_meds_inpt)

#double check join
sum(is.na(join_ID_5))
dim(join_ID_4)
dim(pt_ID_meds_inpt)
dim(join_ID_5)
nrow(join_ID_5 %>% distinct(PATIENT_ID))


#Add in patient id's in med ouitpatient table
pt_ID_meds_outpt <- meds_outpt %>% distinct(PATIENT_ID)
join_ID_6 <- full_join(join_ID_5, pt_ID_meds_outpt)

#double check join
sum(is.na(join_ID_6))
dim(join_ID_5)
dim(pt_ID_meds_outpt)
dim(join_ID_6)
nrow(join_ID_6 %>% distinct(PATIENT_ID))


#Add in patient id's from procedure_icd table
pt_ID_procedure_icd <- procedure_icd %>% distinct(PATIENT_ID)
join_ID_7 <- full_join(join_ID_6, pt_ID_procedure_icd)

#double check join
sum(is.na(join_ID_7))
dim(join_ID_6)
dim(pt_ID_procedure_icd)
dim(join_ID_7)
nrow(join_ID_7 %>% distinct(PATIENT_ID))


#Add in patient id's from procedure_icd table
pt_ID_social_hx <- social_hx %>% distinct(PATIENT_ID)
join_ID_8 <- full_join(join_ID_7, pt_ID_social_hx)

#double check join
sum(is.na(join_ID_8))
dim(join_ID_7)
dim(pt_ID_social_hx)
dim(join_ID_8)
nrow(join_ID_8 %>% distinct(PATIENT_ID))


#Add in patient id's from procedure_icd table
pt_ID_demo <- demo %>% distinct(PATIENT_ID)
join_ID_9 <- full_join(join_ID_8, pt_ID_demo)

#double check join
sum(is.na(join_ID_9))
dim(join_ID_8)
dim(pt_ID_demo)
dim(join_ID_9)
nrow(join_ID_9 %>% distinct(PATIENT_ID))


#Add in patient id's from procedure_icd table
pt_ID_labs <- labs %>% distinct(PATIENT_ID)
join_ID_10 <- full_join(join_ID_9, pt_ID_labs)

#double check join
sum(is.na(join_ID_10))
dim(join_ID_9)
dim(pt_ID_labs)
dim(join_ID_10)
nrow(join_ID_10 %>% distinct(PATIENT_ID))


```

```{r}


#include patients whose first encounter date was = to first Hep C icd code
patients_include <- subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == "TRUE")

#merge table with all unique patient ID's with the patients with a hep c diagnosis
patients <- left_join(join_ID_10, patients_include)

#Add column to identify as hep c = 1 and non hep c = 1
patients$HCV_STATUS <- ifelse(is.na(patients$First_Date_with_Hep_C_ICD_code),0,1)

#reduce to only patient ID and HCV status
patients <- patients[,c(1:3, 5)]

dim(patients)
str(patients)


#double check - should be 2485
nrow(subset(patients, HCV_STATUS ==1))

####NOT WORKING3###
#change date NA's to 12/31/9999 
patients[is.na(patients$First_Date_with_Hep_C_ICD_code),] <- as.Date("12-31-9999")
```

```{r}
#######Demo Varialbes#####

#merge patient id's with demo table

dim(demo)
dim(patients)
pts_demo <- left_join(patients, demo) #add demographics
dim(pts_demo)

str(pts_demo)


pts_demo <- pts_demo[,c( "PATIENT_ID", "HCV_STATUS", "DOB_DS", "Gender", "Race", "Ethnicity", "language", "Marital_Status",      "DOD_DS")] #reducing down the columns
names(pts_demo)[c(3:9)] <- c("DOB","GENDER", "RACE", "ETHNICITY", "LANGUAGE", "MARITAL_STATUS", "DOD") #rename columns

library(eeptools)
##  Not working ##
## DOB ##
pts_demo$age_T0 <- age_calc(dob = DOB, enddate = , units = "years")

## reduce Language levels to 2

levels(pts_demo$language)

levels(pts_demo$LANGUAGE) <- c("Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English",
"Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English",
"Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English") #reducing language to 2 factors

#reduce Marital Status levels to 4

levels(pts_demo$MARITAL_STATUS) <- c("Married_Committed", "Married_Committed", "Unknown", "Divorced_Separated", 
                                     "Divorced_Separated", "Unknown", "Unknown", "Unknown", 
                                     "Unknown", "Divorced_Separated", "Divorced_Separated", "Unknown", 
                                     "Unknown", "Married_Committed", "Unknown", "Unknown", 
                                     "Married_Committed", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Single", "Unknown", 
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                    "Widowed", "Unknown", "Unknown", "Unknown", 
                                    "Unknown", "Unknown")
```

```{r}

#####  Social History Variables ####

#merge patient id's with social history table

dim(social_hx)
dim(patients)
pts_social <- left_join(patients, social_hx) #add demographics
dim(pts_social)

str(pts_social)

#remove observations after First_Date_with_Hep_C_ICD_code
pts_social$BeforeorAfter <-ifelse(is.na(pts_social$First_Date_with_Hep_C_ICD_code), 1,
                                        ifelse(pts_social$First_Date_with_Hep_C_ICD_code < pts_social$Enc_DT_DS, 0, 1))

nrow(subset(pts_social, BeforeorAfter == 0))
nrow(subset(pts_social, is.na(BeforeorAfter)))
nrow(subset(pts_social, BeforeorAfter == 1))

pts_social <- subset(pts_social, BeforeorAfter == 1)

#remove duplicated rows
pts_social <- pts_social[!duplicated(pts_social),]


##### Tobacco ####
#Recoding the Tobacco User status variable -


#NA = 0
#0 = "Not Asked"
#1 = "Never"
#1 = "Passive"
#2 = "Quit"
#2 = "Yes"
levels(pts_social$TOBACCO_USER) <- c("1", "0", "1", "2", "2")
pts_social$TOBACCO_USER[is.na(pts_social$TOBACCO_USER)] <- "0"
table(pts_social$TOBACCO_USER)

pts_social$TOBACCO_USER <- as.numeric(as.character(pts_social$TOBACCO_USER))

#find max status of tobacco
#change formatting of object to factor
pts_max_status <- aggregate(TOBACCO_USER~PATIENT_ID,  data = pts_social, max)
colnames(pts_max_status) <- c("PATIENT_ID", "TOBACCO_USE_STATUS")
pts_max_status$TOBACCO_USE_STATUS<-as.factor(pts_max_status$TOBACCO_USE_STATUS)
levels(pts_max_status$TOBACCO_USE_STATUS) <- c("Unknown", "Never", "Ever")

head(pts_max_status)
dim(pts_max_status)
str(pts_max_status)


### Figure out a tobacco intensity variable????????????? ####

##### Alcohol ####
sum(is.na(pts_social$ALCOHOL_USE_C))
`levels<-`(addNA(pts_social$ALCOHOL_USE), c(levels(pts_social$ALCOHOL_USE), "Unknown"))
pts_social$ALCOHOL_USE[is.na(pts_social$ALCOHOL_USE_C)] <- "0"
table(pts_social$ALCOHOL_USE)
levels(pts_social$ALCOHOL_USE_C)
pts_social$ALCOHOL_USE <- as.numeric(as.character(pts_social$ALCOHOL_USE))

pts_social$ALCOHOL_USE <- as.numeric(as.character(pts_social$ALCOHOL_USE))
df[is.na(df$a),1] <- 88
df$a <- as.factor(df$a)




```

```{r}

######ICD Diagnosis Codes Table#########

###import value sets
value_sets <- read.csv("Z:/Value Sets/Value_Sets.csv", header = TRUE, stringsAsFactor = FALSE)

value_sets$Value_Set_Name<-as.factor(value_sets$Value_Set_Name)
value_sets$icd_dx<-as.factor(value_sets$icd_dx)
value_sets$Definition<-as.factor(value_sets$Definition)
value_sets$Code_System<-as.factor(value_sets$Code_System)

str(Value_Sets)

#reduce value sets to releveant sets and remove duplicate icd codes
reduced_value_sets <- value_sets %>%
                          filter(Value_Set_Name == "AOD Dependence" |
                                Value_Set_Name == "AOD Procedures" |
                                Value_Set_Name == "AOD Rehab and Detox" |
                                Value_Set_Name == "Chemical  Dependency" |
                                Value_Set_Name == "Chlamydia Tests" |
                                Value_Set_Name == "Hepatitis A" |
                                Value_Set_Name == "Hepatitis B" |
                                Value_Set_Name == "HIV" |
                                Value_Set_Name == "IV Drug Abuse" |
                                Value_Set_Name == "Sexual Activity")

codes_from_value_sets <- reduced_value_sets[!duplicated(reduced_value_sets$icd_dx),] #remove duplicateds
#codes_from_value_sets <- as.data.frame(codes_from_value_sets$Code) #creating a dataset of codes only
#colnames(codes_from_value_sets) <- c("icd_dx") #rename to make patients diganosis table
codes_from_value_sets <- droplevels(codes_from_value_sets$icd_dx) #drop extra factor levels
str(codes_from_value_sets)


###  Join patient id table to diagnosis_icd table
pts_diagnosis <- left_join(patients, diagnosis_icd) #add demographics
dim(pts_diagnosis)
str(pts_diagnosis)

#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_diagnosis$BeforeorAfter <-ifelse(is.na(pts_diagnosis$First_Date_with_Hep_C_ICD_code), 1,
                                        ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code < pts_diagnosis$Enc_DT_DS, 0, 1))

#remove observations that occurred after Hep C diagnosis
pts_diagnosis <- pts_diagnosis[(pts_diagnosis$BeforeorAfter == 1),]

#reduce file down to 2 columns - patient_id and icd_dx
pt_icd_codes <- pts_diagnosis[c(1,7)]
str(pt_icd_codes)


##Join value set and pts_diagnosis code to identify value set name of each icd code
pt_icd_codes_value_sets <- inner_join(pt_icd_codes, codes_from_value_sets)
dim(pt_icd_codes)
dim(codes_from_value_sets)
dim(pt_icd_codes_value_sets)


#Create table with frequency of icd codes
icd_freq_table <- as.data.frame.matrix(table(pt_icd_codes_value_sets$PATIENT_ID, pt_icd_codes_value_sets$icd_dx))
str(icd_freq_table)

#Create a column for PATIENT_ID
icd_freq_table$PATIENT_ID <- rownames(icd_freq_table) 

#Remove row names from data.frame
rownames(icd_freq_table) <- NULL

#move PATIENT_ID column to columns 1
icd_freq_table <- icd_freq_table[c(133, 1:132)]

#rename column names to icd_code_freq for columns 2:98
colnames(icd_freq_table)[2:132] <- paste("FREQ", colnames(icd_freq_table[,c(2:132)]), sep = "_")

#join back with all patients that were lost; probably will need to chanage NA's to zeros
#left_join(patients, icd_freq_table)


#Create table with frequency of icd codes### 
icd_freq_variable <- names(sexual_activity_codes[2:12000])

for(x in levels(icd_freq_variable))
patients$x <- if(patients$x == 0, 0, 1))#need to find a way to name it

```