---
title: "Variable Creation"
output: word_document
---

```{r}
#libraries being used in this file
library(dplyr)

```


########   Create Patient table with PATIENT ID, First_Date_with_Hep_C_ICD_code, HCV_STATUS, First_Encounter_Date, Observe_period_yrs ###

##  Find patients with a Hep C icd code and the first date of that code.

```{r}
########Find Hep C patients from icd diagnosis codes

##Match icd 9 codes per Dr Davis's email
hep_c_icd_dx <- subset(diagnosis_icd, 
                        icd_dx == "V02.62" | #Carrier or suspected carrier of Hep C (icd9)
                        icd_dx == "Z22.52" | #Carrier or suspected carrier of Hep C (icd10)
                        icd_dx == "V12.09" | #Hepatitis C, history of (icd9)
                        #icd_dx == "070.41" | #Acute hepatitis C with hepatic coma (icd9)
                        #icd_dx == "070.44" | #Chronic hepatitis C with hepatic coma (icd9)
                        #icd_dx == "070.51" | #Acute hepatitis C without mention of hepatic coma (icd9)
                        icd_dx == "070.54" | #Chronic hepatitis C without mention of hepatic coma; reat that it can be used as hep c in remission (icd9)
                        #icd_dx == "070.7" | #Unspecified viral hepatitis C (icd9)
                        icd_dx == "070.70" | #Unspecified viral hepatitis C without hepatic coma (icd9)
                        icd_dx == "070.71" | #Unspecified viral hepatitis C with hepatic coma (icd9)
                        icd_dx == "B19.20" | #Unspecified viral hepatitis C without hepatic coma (icd10)
                        icd_dx == "B1920" | #Unspecified viral hepatitis C without hepatic coma (icd10)
                        icd_dx == "B18.2" | #Chronic viral hep C (icd10)
                        #icd_dx == "B1710" | #Acute hepatitis C without hepatic coma (icd10)
                        icd_dx == "B19.21" | #Unspecified viral hepatitis C with hepatic coma (icd10)
                        icd_dx == "B1921"  #Unspecified viral hepatitis C with hepatic coma (icd10)
)

#Codes below were not included - These are icd 10 codes - there doesn't seem to be specific Hep C codes during pregnancy for icd 9
#"O98411" (icd10) - Viral hepatitis complicating pregnancy, first trimester
#"O98412" (icd10) - Viral hepatitis complicating pregnancy, second trimester
#"O9842" (icd10) - "VIRAL HEPATITIS COMPLICATING CHILDBIRTH"  
#"O98413" (icd10) - "VIRAL HEPATITIS COMP PREGNANCY THIRD TRIMESTER" 

dim(hep_c_icd_dx)#26540
#table(hep_c_icd_dx$icd_dx)
#table(hep_c_icd_dx$icd_diagnosis)


length(unique(hep_c_icd_dx$PATIENT_ID)) #3768 unique patient id's #3707

#####Find first hep c diagnosis dates#######

#Create an object with id numbers of unique patients with a Hep C icd code and the date of that first diagnosis date
#####

#find earilest hep C icd code using aggregate 
hep_c_patients_ids_first_hep_c_encounter_date <- aggregate(enc_dt_ds~PATIENT_ID,  data = hep_c_icd_dx, min) 

#rename encounter date column
names(hep_c_patients_ids_first_hep_c_encounter_date)[names(hep_c_patients_ids_first_hep_c_encounter_date) == "enc_dt_ds"] <- "First_Date_with_Hep_C_ICD_code"

#str(hep_c_patients_ids_first_hep_c_encounter_date)
#dim(hep_c_patients_ids_first_hep_c_encounter_date)
#length(unique(hep_c_patients_ids_first_hep_c_encounter_date$PATIENT_ID))

```



## Finding First Encounter Date and evaluating whether First Encounter Date was equal to or before First HEP C icd diagnosis date.
```{r}

##Finding first encounter date for Hep C patients
#Filter encounter table on Hep C patients only
hep_c_patient_encounters <- encounters[encounters$PATIENT_ID %in% hep_c_patients_ids_first_hep_c_encounter_date$PATIENT_ID,]
#names(hep_c_patient_encounters)

#reduce dataset to date and id field only
hep_c_patient_encounters_dates <- hep_c_patient_encounters[c("PATIENT_ID", "ENCOUNTER_ID", "PAT_ENC_CSN_ID_DID", "Enc_DT_DS", "Appt_DTTM_DS", "Appt_Checkin_DTTM", "Appt_Cancel_DTTM_DS", "ED_Arrival_DTTM_DS", "Hsp_Adm_DTTM_DS", "Hsp_Disch_DTTM_DS")]
#dim(hep_c_patient_encounters_dates)


#find min encounter date for hep C patients; change column name 
hep_c_patients_first_encounter_date <- aggregate(Enc_DT_DS~PATIENT_ID,  data = hep_c_patient_encounters_dates, min)
names(hep_c_patients_first_encounter_date)[names(hep_c_patients_first_encounter_date) == "Enc_DT_DS"] <- "First_Encounter_Date"

#merge encounter dates with first hep c diangosis date
hep_c_patients_first_encounter_date_and_first_hep_c_icd_code <- merge(hep_c_patients_first_encounter_date, hep_c_patients_ids_first_hep_c_encounter_date, by ="PATIENT_ID")


#Evaluate whether first enounter date is greater, less or equal to first encounter date -
##BEFORE = first encounter date is before first Hep C ICD code
#SAME = first encounter date is the same as first Hep C ICD code
hep_c_patients_first_encounter_date_and_first_hep_c_icd_code$EncountervsICD <- ifelse(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code$First_Encounter_Date < hep_c_patients_first_encounter_date_and_first_hep_c_icd_code$First_Date_with_Hep_C_ICD_code,  "BEFORE", "SAME")

nrow(subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == 'BEFORE'))  ##2485
nrow(subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == 'SAME'))  #1220

str(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code)
```


##  Elimiinate patients with First Encounter Date = to First Hep C Date
##  Add column that idenifies patients as HCV postive (1) or HCV negative (0)
```{r}


#include patients whose first encounter date was < to first Hep C icd code - patients diagnosed during our time horizon
patients_include <- subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == "BEFORE")

#create table with all unique patient ID's from all tables except meds_inpt and meds_outpt
unique_pt_id_all_tbls<-as.data.frame(unique(c(cpt$PATIENT_ID,demo$PATIENT_ID,diagnosis_icd$PATIENT_ID,encounters$PATIENT_ID,procedure_icd$PATIENT_ID,social_hx$PATIENT_ID)))
names(unique_pt_id_all_tbls)[1]<-paste("PATIENT_ID")

#exclude patients who have hep c but didn't get it during our time horizon
patients_exclude <- subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == "SAME")

#master list of patients in scope for the analysis
patients <- left_join(unique_pt_id_all_tbls,patients_include)
old_rows<-nrow(patients)
patients<-anti_join(patients,patients_exclude, by = "PATIENT_ID")
new_rows<-nrow(patients)
deleted_rows<-old_rows-new_rows; deleted_rows

#Add column to identify as hep c = 1 and non hep c = 1
patients$HCV_STATUS <- ifelse(is.na(patients$First_Date_with_Hep_C_ICD_code),0,1)
patients<-patients[order(patients$PATIENT_ID),]

#double check - should be 2485
nrow(subset(patients, HCV_STATUS ==1))

#for patients who are not diagnosed with Hep_C make the First_Date_with_Hep_C_ICD_code 9999-12-31
patients$enddate<-as.Date.character("9999-12-31","%Y-%m-%d")
patients$first_date<-as.Date.numeric(ifelse(is.na(patients$First_Date_with_Hep_C_ICD_code),patients$enddate,patients$First_Date_with_Hep_C_ICD_code),origin = "1970-01-01")
patients$First_Date_with_Hep_C_ICD_code<-patients$first_date

#reduce to only patient ID and HCV status, first diagnosis date
patients <- patients[,c(1, 3, 5)]

#Filter encounter table on patietns in scope for analysis only
pt_encounters <- encounters[encounters$PATIENT_ID %in% patients$PATIENT_ID,]

#Time Difference between First Encounter and First Hep C icd code for Hep C patients or Decmeber 31, 2015 for non Hep C aptients
#find min encounter date for hep C patients; change column name 
pts_first_encounter_date <- aggregate(Enc_DT_DS~PATIENT_ID,  data = pt_encounters, min)
names(pts_first_encounter_date)[names(pts_first_encounter_date) == "Enc_DT_DS"] <- "First_Encounter_Date"


#merge first encounter date with patient data 
patients <- left_join(patients, pts_first_encounter_date)

#calcuate observation period for each patient; it will be the same for HCV negative patients; unique for each HCV postive patient
observation_start_date <-as.Date.character("2011-01-01","%Y-%m-%d")
patients$Observe_period_yrs <- ifelse(patients$HCV_STATUS == 0, 6,
                                                     (difftime(patients$First_Date_with_Hep_C_ICD_code, observation_start_date, 
                                                               units = "days")/365))

##remove patients without a first encounter date
patients <- patients[(!is.na(patients$First_Encounter_Date)),]

#rearranging columns
patients <- patients[,c(1, 4, 2, 5, 3)]

str(patients) #283661 patients

#export to flat file folder
#write.csv(patients, "Z:/Flat File/patients_list.csv", row.names = FALSE)

#exploratory analysis

#table(patients$HCV_STATUS)

#pos <- subset(patients, HCV_STATUS == 1)
#neg <- subset(patients, HCV_STATUS == 0)

#sum(pos$Observe_period_yrs)
#sum(neg$Observe_period_yrs)

```


####################  Variables from Demo Table ####################


```{r}
#######Demo Varialbes#####

#merge patient id's with demo table

pts_demo <- left_join(patients, demo) #add demographics table
dim(pts_demo)
dim(demo)
#str(pts_demo)

## Age ##

#Binned  by generation cohort ##

#Millennial - Born after 1980
#Gen X - Born 1965 to 1980
#Baby Boomer - Born 1946 to 1964
#Silent - Born 1945 and before


pts_demo$GENERATION_CATEGORY <- ifelse(pts_demo$DOB_DS < "1945/01/01", "Silent",
                                ifelse(pts_demo$DOB_DS >= "1945/01/01" & pts_demo$DOB_DS < "1964/01/01","Baby Boomer",
                                ifelse(pts_demo$DOB_DS >=" 1964/01/01" & pts_demo$DOB_DS < "1980/01/01", "Gen X",
                                ifelse(pts_demo$DOB_DS >= "1980/01/01", "Millennial", "Unknown"))))
pts_demo$GENERATION_CATEGORY <- as.factor(pts_demo$GENERATION_CATEGORY)
table(pts_demo$HCV_STATUS, pts_demo$GENERATION_CATEGORY)

#Binned in 5 year catorgies ##
library(eeptools)
pts_demo$AGE <- (age_calc(dob = pts_demo$DOB_DS, enddate = pts_demo$First_Encounter_Date, units = "years"))  #calcuate age at time of first encounter
pts_demo$AGE <- trunc(pts_demo$AGE) #trunc to get whole number
## Bin Age #
pts_demo$AGE_CATEGORY <- ifelse(pts_demo$AGE <=24, "<25",
                                ifelse(pts_demo$AGE >= 25 & pts_demo$AGE <=29, "25-29",
                                ifelse(pts_demo$AGE >= 30 & pts_demo$AGE <=34, "30-34",
                                ifelse(pts_demo$AGE >= 35 & pts_demo$AGE <=39, "35-39",
                                ifelse(pts_demo$AGE >= 40 & pts_demo$AGE <=44, "40-44",
                                ifelse(pts_demo$AGE >= 45 & pts_demo$AGE <=49, "45-49",
                                ifelse(pts_demo$AGE >= 50 & pts_demo$AGE <=54, "50-54",
                                ifelse(pts_demo$AGE >= 55 & pts_demo$AGE <=59, "55-59",
                                ifelse(pts_demo$AGE >= 60 & pts_demo$AGE <=64, "60-64",
                                ifelse(pts_demo$AGE >= 65 & pts_demo$AGE <=69, "65-69",
                                ifelse(pts_demo$AGE >= 70 & pts_demo$AGE <=74, "70-74",
                                ifelse(pts_demo$AGE >= 75 & pts_demo$AGE <=79, "75-79",
                                ifelse(pts_demo$AGE >= 80, "80+", "Unknown")))))))))))))       
pts_demo$AGE_CATEGORY <- as.factor(pts_demo$AGE_CATEGORY) #changing data strcture to factor

#mean(pts_demo$AGE[pts_demo$HCV_STATUS == 0])
#table(pts_demo$HCV_STATUS, pts_demo$AGE_CATEGORY)

## reduce columans
pts_demo <- pts_demo[,c( "PATIENT_ID", "Gender", "Race", "Ethnicity", "language", "Marital_Status", "AGE_CATEGORY", "GENERATION_CATEGORY")] #reducing down the columns
names(pts_demo)[c(2:6)] <- c("GENDER", "RACE", "ETHNICITY", "LANGUAGE", "MARITAL_STATUS") #rename columns

## Remove NA's
pts_demo[,"RACE"][is.na(pts_demo[,"RACE"])] <- "Unknown"
pts_demo[,"ETHNICITY"][is.na(pts_demo[,"ETHNICITY"])] <- "Unknown"

## Language ##
## reduce Language levels to 3 
levels(pts_demo$LANGUAGE) <- c("Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", 
                               "Non-English", "Non-English", "Non-English", "Non-English", "Unknown")

pts_demo[,"LANGUAGE"][is.na(pts_demo[,"LANGUAGE"])] <- "Unknown" #changing NA's to "Unknonw"

## Marital Status ##
#reduce Marital Status levels to 4
levels(pts_demo$MARITAL_STATUS) <- c("Married_Committed", "Married_Committed", "Unknown", "Divorced_Separated", 
                                     "Divorced_Separated", "Unknown", "Unknown", "Unknown", 
                                     "Unknown", "Divorced_Separated", "Divorced_Separated", "Unknown", 
                                     "Unknown", "Married_Committed", "Unknown", "Unknown", 
                                     "Married_Committed", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Single", "Unknown", 
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                    "Widowed", "Unknown", "Unknown", "Unknown", 
                                    "Unknown", "Unknown")

pts_demo[,"MARITAL_STATUS"][is.na(pts_demo[,"MARITAL_STATUS"])] <- "Unknown"

str(pts_demo)
sum(is.na(pts_demo))

#export to flat file folder
write.csv(pts_demo, "Z:/Flat File/pts_demo.csv", row.names = FALSE)
#Patient variables = 1
#Demographic variables = 2-8


##Join to Flat File
flat_file <- left_join(patients, pts_demo)
str(flat_file)
#Patient variables = 1-5
#Demographic variables = 6-12


##EXploratory Analysis
table(flat_file$HCV_STATUS, flat_file$GENDER)
prop.table(table(flat_file$HCV_STATUS, flat_file$GENDER))

table(flat_file$HCV_STATUS, flat_file$RACE)
unique(flat_file$RACE)
prop.table(table(flat_file$HCV_STATUS, flat_file$RACE))

table(flat_file$HCV_STATUS, flat_file$ETHNICITY)
unique(flat_file$ETHNICITY)
prop.table(table(flat_file$HCV_STATUS, flat_file$ETHNICITY))

table(flat_file$HCV_STATUS, flat_file$LANGUAGE)
unique(flat_file$LANGUAGE)
prop.table(table(flat_file$HCV_STATUS, flat_file$LANGUAGE))

table(flat_file$HCV_STATUS, flat_file$MARITAL_STATUS)
unique(flat_file$MARITAL_STATUS)
prop.table(table(flat_file$HCV_STATUS, flat_file$MARITAL_STATUS))

table(flat_file$HCV_STATUS, flat_file$AGE_CATEGORY)
unique(flat_file$AGE_CATEGORY)
prop.table(table(flat_file$HCV_STATUS, flat_file$AGE_CATEGORY))

table(flat_file$HCV_STATUS, flat_file$GENERATION_CATEGORY)
unique(flat_file$GENERATION_CATEGORY)
prop.table(table(flat_file$HCV_STATUS, flat_file$GENERATION_CATEGORY))
```




####################  Variables from ICD Diagnosis Table ####################


```{r}

######ICD Diagnosis Codes Table#########

###import value sets
HEDIS_value_sets <- read_delim("Z:/Value Sets/Value_Sets.csv", ",", escape_double = FALSE, trim_ws = TRUE)

HEDIS_value_sets <- HEDIS_value_sets[1:135657,] #dropping empty rows at end
tail(HEDIS_value_sets)
str(HEDIS_value_sets)

#reduce value sets to releveant sets and remove duplicate icd codes
hep_c_project_HEDIS_value_sets <- subset(HEDIS_value_sets, Value_Set_Name == "AOD Dependence" |
                                Value_Set_Name == "AOD Procedures" |
                                Value_Set_Name == "AOD Rehab and Detox" |
                                Value_Set_Name == "Chemical Dependency" |
                                Value_Set_Name == "Chlamydia Tests" |
                                Value_Set_Name == "Detoxification" |
                                Value_Set_Name == "Hepatitis A" |
                                Value_Set_Name == "Hepatitis B" |
                                Value_Set_Name == "HIV" |
                                Value_Set_Name == "IV Drug Abuse" |
                                Value_Set_Name == "Sexual Activity")
str(hep_c_project_HEDIS_value_sets) #2015 obserations

#For ICD codes
hep_c_project_HEDIS_icd_codes <- subset(hep_c_project_HEDIS_value_sets, Code_System == "ICD9CM" | Code_System == "ICD10CM") #only ICD diagnosis codes only

hep_c_project_HEDIS_icd_codes[!duplicated(hep_c_project_HEDIS_icd_codes$Code),]

hep_c_project_HEDIS_icd_codes$Code <- gsub("\\..*", "", hep_c_project_HEDIS_icd_codes$Code) #drop the decimal point and any numbers after
hep_c_project_HEDIS_icd_codes$Code <- str_pad(hep_c_project_HEDIS_icd_codes$Code, 4, pad = "0") #pad so all codes are 4 characters long
hep_c_project_HEDIS_icd_codes <- hep_c_project_HEDIS_icd_codes[!duplicated(hep_c_project_HEDIS_icd_codes$Code),] #remove duplicates icd;

str(hep_c_project_HEDIS_icd_codes)
```

```{r}

#### ICD Codes ####
####  Combine icd table and cpt_ucpg table  ###########


#Join 2 tables with icd codes in them; reduce columns and rename

## Format icd table
reduced_diagnosis_icd <- diagnosis_icd[c("PATIENT_ID", "enc_dt_ds", "icd_dx", "icd_diagnosis")]
colnames(reduced_diagnosis_icd) <- c("PATIENT_ID", "Date", "Code", "Desc")

str(reduced_diagnosis_icd)

## Format ucpg table
#extract each icd rank and recombine them to one dataset
reduced_cpt_ucpg_1 <- cpt_ucpg[c("Patient_Id", "Date" = "Date_of_Service_DS", "ICD9_CM_CODE_1")]
colnames(reduced_cpt_ucpg_1) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_2 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_2")]
colnames(reduced_cpt_ucpg_2) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_3 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_3")]
colnames(reduced_cpt_ucpg_3) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_4 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_4")]
colnames(reduced_cpt_ucpg_4) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_5 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_5")]
colnames(reduced_cpt_ucpg_5) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_6 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_6")]
colnames(reduced_cpt_ucpg_6) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_7 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_7")]
colnames(reduced_cpt_ucpg_7) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_8 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_8")]
colnames(reduced_cpt_ucpg_8) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg_9 <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "ICD9_CM_CODE_9")]
colnames(reduced_cpt_ucpg_9) <- c("PATIENT_ID", "Date", "Code")

reduced_cpt_ucpg <- rbind(reduced_cpt_ucpg_1, reduced_cpt_ucpg_2, reduced_cpt_ucpg_3, reduced_cpt_ucpg_4, reduced_cpt_ucpg_5, reduced_cpt_ucpg_6, reduced_cpt_ucpg_7, reduced_cpt_ucpg_8, reduced_cpt_ucpg_9)

reduced_cpt_ucpg <- reduced_cpt_ucpg[!is.na(reduced_cpt_ucpg$Code),]

reduced_cpt_ucpg$Desc <- NA

##CHOOSE WHAT TABLES TO INCLUDE ---------------------------
modified_diagnosis_icd <- rbind(reduced_diagnosis_icd, reduced_cpt_ucpg)
#modified_diagnosis_icd <- reduced_diagnosis_icd

str(modified_diagnosis_icd)


#Change icd table so format of icd codes match HEDIS files
modified_diagnosis_icd$Code <- gsub("\\..*", "", modified_diagnosis_icd$Code) #remove any numbers after decimal point
modified_diagnosis_icd$Code <- str_pad(modified_diagnosis_icd$Code, 4, pad = "0") #pad so all codes are 4 characters long; pads to the front of the string
modified_diagnosis_icd$Code <-as.factor(modified_diagnosis_icd$Code) #chanage to a factor


###  Join patient id table to diagnosis_icd table to bring in first Hep C date
pts_diagnosis <- inner_join(patients, modified_diagnosis_icd) #8,479,127 rows
#dim(pts_diagnosis)
#str(pts_diagnosis)

#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_diagnosis$BeforeorAfter <- ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code < pts_diagnosis$Date, "After", 
                                      ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code == pts_diagnosis$Date, "Same", "Before"))

#nrow(pts_diagnosis[(pts_diagnosis$ICD_TYPE == 9),])#7,961,673 rows
#nrow(pts_diagnosis[(pts_diagnosis$ICD_TYPE == 10),])#518,101 rows

#include observations that occurred before first Hep C diagnosis
pt_icd_codes <- pts_diagnosis[(pts_diagnosis$BeforeorAfter == "Before"),]

str(pt_icd_codes)
```



```{r}
###Evaluating Hep codes that occur before what we are sayingis "first icd diagnois date"
hep_codes_left <- subset(pt_icd_codes, 
                        Code == "0070"  #Acute hepatitis C with hepatic coma (icd9)
                       | Code == "B1710" #Acute hepatitis C without hepatic coma (icd10)

) #3395 codes
hep_codes_left[!duplicated(hep_codes_left),] #2945
hep_codes_left$Desc<-droplevels(hep_codes_left$Desc)
table(hep_codes_left$Desc)
length(unique(hep_codes_left$PATIENT_ID))  #737; 
subset(hep_codes_left, HCV_STATUS ==0) 


hep__c_codes_left <- hep_codes_left[grep("HEPATITIS C", hep_codes_left$Desc), ] #100 (41- neg and 59 - pos)
length(unique(hep__c_codes_left$PATIENT_ID)) #83 unique patients - 37 neg and 46 pos
table(hep__c_codes_left$PATIENT_ID, hep__c_codes_left$HCV_STATUS)
pos <- subset(hep__c_codes_left, HCV_STATUS ==1) 
length(unique(pos$PATIENT_ID)) #83 unique patients


```



```{r}

####  Creating Tables of ICD Counts, ICD Averages, and ICD Binary (1=ICD present before first HEp C icd code or 0=ICD not present before first Hep C icd code)#


##Join value set and pts_diagnosis code to identify value set name of each icd code
pt_icd_codes_value_sets <- inner_join(hep_c_project_HEDIS_icd_codes, pt_icd_codes)
dim(pt_icd_codes)
dim(hep_c_project_HEDIS_icd_codes)
dim(pt_icd_codes_value_sets)

##Evaluating join
#pt_icd_codes_value_sets[is.na(pt_icd_codes_value_sets$PATIENT_ID) & pt_icd_codes_value_sets$Code_System == "ICD9CM",]
#diagnosis_icd[grep("HIV", diagnosis_icd$icd_diagnosis),]

#Create table with frequency of icd codes
icd_freq_table <- as.data.frame.matrix(table(pt_icd_codes_value_sets$PATIENT_ID, pt_icd_codes_value_sets$Code))
#str(icd_freq_table)

icd_freq_table$PATIENT_ID <- rownames(icd_freq_table)  #Create a column for PATIENT_ID
icd_freq_table <- icd_freq_table[c(57, 1:56)] #move PATIENT_ID column to columns 1
colnames(icd_freq_table)[2:57] <- paste("FREQ_ICD", colnames(icd_freq_table[,c(2:57)]), sep = "_")#rename column names to icd_code_freq for columns 2:56
rownames(icd_freq_table) <- NULL#Remove row names from data.frame

#join back with patients id's that were lost; 
pts_icd <- left_join(patients, icd_freq_table)
str(pts_icd)

#Divide Freq by length of observtion period (in years) to calculate average numbe per observation perios
pts_icd[,62:117] <- apply(pts_icd[,6:ncol(pts_icd)], 2, function (x) {
          x/pts_icd$Observe_period_yrs})

#Rename Average columns
newnames <- (gsub('FREQ_', "AVERAGE_", colnames(pts_icd[,6:61])))
colnames(pts_icd)[62:117] <- paste(newnames)     
str(pts_icd)
names(pts_icd)
sum(is.na(pts_icd))

###Presence of ICD diagnosis code - HEDIS 
# 0 = never had the icd code
# 1 = had the icd code at least once

pts_icd[,118:173] <- apply(pts_icd[,6:117], c(1,2), function(x) {
 ifelse(x == 0, 0, 1)})

newnames2 <- (gsub('FREQ_', "BINARY_", colnames(pts_icd[,6:61])))
colnames(pts_icd)[118:173] <- paste(newnames2)

dim(pts_icd)
names(pts_icd)
str(pts_icd)

# chanage NA's to zeros
pts_icd[,6:ncol(pts_icd)][is.na(pts_icd[,6:ncol(pts_icd)])] <- 0 
pts_icd <- pts_icd[-c(2:5)]

#export HEDIS icd variables to flat file folder
write.csv(pts_icd, "Z:/Flat File/pts_HEDIS_ICD.csv", row.names = FALSE)
  #Patient variables = 1
  #Freq HEDIS ICD codes = 2 - 57 (Baseline)
  #Average HEDIS ICD codes = 58 - 113
  #Binary HEDIS ICD codes = 114 - 169


#Join to flat file - Merge with patient info, demo variables, and ICD variables
flat_file <- left_join(flat_file, pts_icd)
str(flat_file)
names(flat_file)
  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180

#Exploratory Analysis

#post <- subset(flat_file, HCV_STATUS == 1)
#pos_pts_icd <- as.data.frame(colSums(post[c(125:180)],))
#write.csv(pos_pts_icd, "Z:/Flat File/FREQ_HEDIS_ICD.csv", row.names = FALSE)
#neg <- subset(flat_file, HCV_STATUS == 0)
#neg_pts_icd <- as.data.frame(colSums(neg[c(125:180)],))
#write.csv(neg_pts_icd, "Z:/Flat File/Neg_FREQ_HEDIS_ICD.csv", row.names = FALSE)
```

```{r}

#################### ICD Diagnosis Codes -  CCS categories ##########

###  Import CCS  9 categories  ####

ccs_9 <- read.csv("Z:/Value Sets/CCSCategoryNames_ICD9.csv", header = TRUE, stringsAsFactor = FALSE)

#Formatting CCS file
ccs_9$X.ICD.9.CM.CODE. <- sub(".$", "", ccs_9$X.ICD.9.CM.CODE.)#remove last character in string
ccs_9$X.ICD.9.CM.CODE. <- sub("^.", "", ccs_9$X.ICD.9.CM.CODE.)#remove first character in string

ccs_9$X.ICD.9.CM.CODE. <- trimws(ccs_9$X.ICD.9.CM.CODE., which = c("right")) #remove extra spaces
ccs_9$X.ICD.9.CM.CODE. <- str_pad(ccs_9$X.ICD.9.CM.CODE., 5, "right", pad = "0") #add zeros at the end

ccs_9 <- ccs_9 [c("X.ICD.9.CM.CODE.",  "CCS.CATEGORY", "X.CCS.CATEGORY.DESCRIPTION.")]
colnames(ccs_9) <- c("Code", "CCS_CATEGORY", "CCS_DESC")
ccs_9 <- ccs_9[!duplicated(ccs_9$Code),]
str(ccs_9)
subset(ccs_9, CCS_CATEGORY == 2602)

###  Import CCS  10 categories  ####

ccs_10 <- read.csv("Z:/Value Sets/ccs_dx_icd10cm_2017.csv", header = TRUE, stringsAsFactor = FALSE)

#Formatting CCS file
ccs_10$X.ICD.10.CM.CODE. <- sub(".$", "", ccs_10$X.ICD.10.CM.CODE.)#remove last character in string
ccs_10$X.ICD.10.CM.CODE. <- sub("^.", "", ccs_10$X.ICD.10.CM.CODE.)#remove first character in string

ccs_10$X.CCS.CATEGORY. <- sub(".$", "", ccs_10$X.CCS.CATEGORY.)#remove last character in string
ccs_10$X.CCS.CATEGORY. <- sub("^.", "", ccs_10$X.CCS.CATEGORY.)#remove first character in string

ccs_10 <- ccs_10 [c("X.ICD.10.CM.CODE.",  "X.CCS.CATEGORY.", "X.CCS.CATEGORY.DESCRIPTION.")]
colnames(ccs_10) <- c("Code", "CCS_CATEGORY", "CCS_DESC")
str(ccs_10)
```



```{r}


#### icd Diagnosis table - ICD Codes ####
#### Map ICD codes to CCS categories  ###########

reduced_diagnosis_icd <- diagnosis_icd[c("PATIENT_ID", "enc_dt_ds", "icd_dx", "ICD_TYPE", "icd_diagnosis")]
colnames(reduced_diagnosis_icd) <- c("PATIENT_ID", "Date", "Code", "Type", "Desc")

### ICD 9 ###
reduced_diagnosis_icd_9 <- subset(reduced_diagnosis_icd, Type == "9") #8,016,285
reduced_diagnosis_icd_9 <- reduced_diagnosis_icd_9[,-4]

reduced_diagnosis_icd_9$Code <- gsub("\\.", "", reduced_diagnosis_icd_9$Code) #remove decimal point
reduced_diagnosis_icd_9$Code <- str_pad(reduced_diagnosis_icd_9$Code, 5, "right", pad = "0") #pad so all codes are 4 characters long

#join icd 9 codes from diagnosis table to ccs categories
icd_9_codes_ccs <- inner_join(reduced_diagnosis_icd_9, ccs_9)
dim(icd_9_codes_ccs) #8,016,284
dim(reduced_diagnosis_icd_9)  #8,016,285
dim(ccs_9)  #14800

### ICD 10 ###
reduced_diagnosis_icd_10 <- subset(reduced_diagnosis_icd, Type == "10") #520,609
reduced_diagnosis_icd_10 <- reduced_diagnosis_icd_10[,-4]

#join icd 10 codes from diagnosis table to ccs categories
icd_10_codes_ccs <- inner_join(reduced_diagnosis_icd_10, ccs_10)
dim(icd_10_codes_ccs) #512,891
dim(reduced_diagnosis_icd_10) #520,609
dim(ccs_10) #71807

icd_codes_css <- rbind(icd_9_codes_ccs, icd_10_codes_ccs)
str(icd_codes_css)

```


```{r}
## Format ucpg table
#extract each icd rank and recombine them to one dataset

#reduced_cpt_ucpg_1 <- cpt_ucpg[c("PATIENT_ID", "Date" = "Date_of_Service_DS", "ICD9_CM_CODE_1")]
#colnames(reduced_cpt_ucpg_1) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_2 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_2")]
#colnames(reduced_cpt_ucpg_2) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_3 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_3")]
#colnames(reduced_cpt_ucpg_3) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_4 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_4")]
#colnames(reduced_cpt_ucpg_4) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_5 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_5")]
#colnames(reduced_cpt_ucpg_5) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_6 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_6")]
#colnames(reduced_cpt_ucpg_6) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_7 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_7")]
#colnames(reduced_cpt_ucpg_7) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_8 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_8")]
#colnames(reduced_cpt_ucpg_8) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg_9 <- cpt_ucpg[c("PATIENT_ID", "Date_of_Service_DS", "ICD9_CM_CODE_9")]
#colnames(reduced_cpt_ucpg_9) <- c("PATIENT_ID", "Date", "Code")

#reduced_cpt_ucpg <- rbind(reduced_cpt_ucpg_1, reduced_cpt_ucpg_2, reduced_cpt_ucpg_3, reduced_cpt_ucpg_4, reduced_cpt_ucpg_5, reduced_cpt_ucpg_6, reduced_cpt_ucpg_7, reduced_cpt_ucpg_8, reduced_cpt_ucpg_9)

#reduced_cpt_ucpg <- reduced_cpt_ucpg[!is.na(reduced_cpt_ucpg$Code),]

#reduced_cpt_ucpg$Code <- gsub("\\.", "", reduced_cpt_ucpg$Code) #remove decimal point
#reduced_cpt_ucpg$Code <- str_pad(reduced_cpt_ucpg$Code, 5, "right", pad = "0") #pad so all codes are 4 characters long
#modified_diagnosis_icd$Code <-as.factor(modified_diagnosis_icd$Code) #chanage to a factor

#cpt_ucpg_codes_css <- left_join(reduced_cpt_ucpg, ccs)
#dim(cpt_ucpg_codes_css)
#dim(join)
#dim(ccs)

##evaluatign join
#sum(is.na(join$CCS_CATEGORY))  #26812 = na's for 9; #369552 = na's for 10

##Add icd codes from cpt_ucpg table to diagnosis table
#icd_codes_css <- rbind(icd_codes_css, reduced_cpt_ucpg)
#str(icd_codes_css)
```

```{r}
## Reduce icd codes with ccs catgories to only patients in our cohort ###
pts_CCS_ICD_codes <- inner_join(patients, icd_codes_css) 
dim(pts_CCS_ICD_codes) #8,456,100
dim(patients) #283,661
dim(icd_codes_css) #8,529,175 


#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_CCS_ICD_codes$BeforeorAfter <- ifelse(pts_CCS_ICD_codes$First_Date_with_Hep_C_ICD_code < pts_CCS_ICD_codes$Date, "After", 
                                      ifelse(pts_CCS_ICD_codes$First_Date_with_Hep_C_ICD_code == pts_CCS_ICD_codes$Date, "Same", "Before"))

#include observations that occurred before first Hep C diagnosis only
pts_CCS_ICD_codes <- pts_CCS_ICD_codes[(pts_CCS_ICD_codes$BeforeorAfter == "Before"),] #8,099,653
str(pts_CCS_ICD_codes) #8,232,623

#Create table with frequency of ccs categories
ccs_freq_table <- as.data.frame.matrix(table(pts_CCS_ICD_codes$PATIENT_ID, pts_CCS_ICD_codes$CCS_CATEGORY))
str(ccs_freq_table)

ccs_freq_table$PATIENT_ID <- rownames(ccs_freq_table)  #Create a column for PATIENT_ID
ccs_freq_table <- ccs_freq_table[c(282, 1:281)] #move PATIENT_ID column to columns 1
colnames(ccs_freq_table)[2:282] <- paste("FREQ_ICD_CCS", colnames(ccs_freq_table[,c(2:282)]), sep = "_")#rename column names to icd_code_freq for columns 2:282
rownames(ccs_freq_table) <- NULL#Remove row names from data.frame

#join back with patients id's that were lost; 
ccs_table <- left_join(patients, ccs_freq_table)
str(ccs_table)
names(ccs_table)

#Exploratory Analysis

#post <- subset(ccs_table, HCV_STATUS == 1)
#pos_pts_icd <- as.data.frame(colSums(post[c(6:286)], na.rm=TRUE))
#write.csv(pos_pts_icd, "Z:/Flat File/FREQ_HEDIS_ICD.csv", row.names = FALSE)
#neg <- subset(ccs_table, HCV_STATUS == 0)
#neg_pts_icd <- as.data.frame(colSums(neg[c(6:286)], na.rm=TRUE))
#write.csv(neg_pts_icd, "Z:/Flat File/Neg_FREQ_HEDIS_ICD.csv", row.names = FALSE)

#Divide Freq by length of observtion period (in years) to calculate average numbe per observation perios

ccs_table[,287:567] <- apply(ccs_table[,6:286], 2, function (x) {
          x/ccs_table$Observe_period_yrs})

#Rename Average columns
CCS_newnames <- (gsub('FREQ_', "AVERAGE_", colnames(ccs_table[,6:286])))
colnames(ccs_table)[287:567] <- paste(CCS_newnames)     
names(ccs_table)

###Presence of ICD diagnosis code - HEDIS 
# 0 = never had the icd code
# 1 = had the icd code at least once

ccs_table[,568:847] <- apply(ccs_table[,6:286], c(1,2), function(x) {
 ifelse(x == 0, 0, 1)})

CCS_newnames2 <- (gsub('FREQ_', "BINARY_", colnames(ccs_table[,6:286])))
colnames(ccs_table)[568:847] <- paste(CCS_newnames2)

names(ccs_table)
str(ccs_table)

# chanage NA's to zeros
ccs_table[,6:ncol(ccs_table)][is.na(ccs_table[,6:ncol(ccs_table)])] <- 0 
ccs_table <- ccs_table[-c(2:286)]#remove patient variables and FREQ variables

sum(is.na(ccs_table))
dim(ccs_table)

#export CCS icd variables to flat file folder
write.csv(ccs_table, "Z:/Flat File/pts_CCS_ICD.csv", row.names = FALSE)
  #Patient variables = 1
  #Average CCS ICD codes = 2 - 282
  #Binary CCS ICD codes = 283 - 562


#Join to flat file - Merge with patient info, demo variables, and ICD variables
flat_file <- left_join(flat_file, ccs_table)
str(flat_file)

  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180
  #Average CCS ICD codes = 181 - 461
  #Binary CCS ICD codes = 462 - 741


#Exploratory Analysis

#post <- subset(flat_file, HCV_STATUS == 1)
#pos_pts_icd <- as.data.frame(colSums(post[c(462:741)], na.rm=TRUE))
#write.csv(pos_pts_icd, "Z:/Flat File/FREQ_HEDIS_ICD.csv", row.names = FALSE)
#neg <- subset(flat_file, HCV_STATUS == 0)
#neg_pts_icd <- as.data.frame(colSums(neg[c(462:741)], na.rm=TRUE))
#write.csv(neg_pts_icd, "Z:/Flat File/Neg_FREQ_HEDIS_ICD.csv", row.names = FALSE)
```


####################  Variables from CPT and ICD_procedure table ####################



```{r}
###  CPT Tables #######

###  Prep procedure codes from HEDIS value sets

hep_c_project_HEDIS_procedure_codes <- subset(hep_c_project_HEDIS_value_sets, Code_System == "CPT" | Code_System == "ICD10PCS" | Code_System == "ICD9PCS" | Code_System ==  "HCPCS") #only Procedure codes only #383 codes

hep_c_project_HEDIS_procedure_codes$Code <- gsub("\\..*", "", hep_c_project_HEDIS_procedure_codes$Code) #drop the decimal point and any numbers after
hep_c_project_HEDIS_procedure_codes <- hep_c_project_HEDIS_procedure_codes[!duplicated(hep_c_project_HEDIS_procedure_codes$Code),] #remove duplicates codes;  #237 codes



####  COMBINE cpt, cpt_ucpg, and procedure icd table ###

#Join 3 tables with procedure codes; reduce tables to only patient_ID and CPT column and join the 3 tables together
reduced_procedure_icd <- procedure_icd[c("PATIENT_ID", "enc_dt_ds", "icd_px", "icd_procedure")]
colnames(reduced_procedure_icd) <- c("PATIENT_ID", "Date", "Code", "Desc")

reduced_cpt <- cpt[c("PATIENT_ID", "enc_dt_ds", "CPT", "CPT_Procedure")]
colnames(reduced_cpt) <- c("PATIENT_ID", "Date", "Code", "Desc") 

levels(reduced_procedure_icd$Code)

reduced_cpt_ucpg <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "CPT_Code")]
colnames(reduced_cpt_ucpg) <- c("PATIENT_ID", "Date", "Code")
reduced_cpt_ucpg$Desc <- NA

### CHOOSE WHICH TABLES TO USE BY REMVOING TABLES!!##
all_cpt <- rbind(reduced_procedure_icd, reduced_cpt, reduced_cpt_ucpg)

all_cpt$Code <- gsub("\\..*", "", all_cpt$Code) #drop the decimal point and any numbers after

str(all_cpt)



###  Join patient id table to all cpt table
pts_cpt <- inner_join(patients, all_cpt) 
dim(patients) #283,661
dim(all_cpt) #741,948
dim(pts_cpt)  #524,693

#identify which observations occurred after First_Date_with_Hep_C_ICD_code
pts_cpt$BeforeorAfter <-ifelse(is.na(pts_cpt$First_Date_with_Hep_C_ICD_code), "After",
                                        ifelse(pts_cpt$First_Date_with_Hep_C_ICD_code < pts_cpt$Date, "Same", "Before"))

#remove observations that occurred after Hep C diagnosis
pts_cpt <- pts_cpt[(pts_cpt$BeforeorAfter == "Before"),]

nrow(subset(pts_cpt, BeforeorAfter == "Before"))

#reduce file down to 2 columns - patient_id and procedure code
pt_cpt_codes <- pts_cpt[c("PATIENT_ID", "Code")]
str(pt_cpt_codes)


##Join value set and pts_cpt code to identify value set name of each icd code
pt_cpt_codes_value_sets <- inner_join(pt_cpt_codes, hep_c_project_HEDIS_procedure_codes)
dim(pt_cpt_codes) #524,693
dim(hep_c_project_HEDIS_procedure_codes) #237
dim(pt_cpt_codes_value_sets) #13856


#Create table with frequency of icd codes
cpt_freq_table <- as.data.frame.matrix(table(pt_cpt_codes_value_sets$PATIENT_ID, pt_cpt_codes_value_sets$Code))
str(cpt_freq_table)

cpt_freq_table$PATIENT_ID <- rownames(cpt_freq_table) #Create a column for PATIENT_ID
cpt_freq_table <- cpt_freq_table[c(60, 1:59)]#move PATIENT_ID column to columns 1
rownames(cpt_freq_table) <- NULL#Remove row names from data.frame

#rename column names to cpt_freq_table for columns 2:60
colnames(cpt_freq_table)[2:60] <- paste("FREQ_PROC", colnames(cpt_freq_table[,c(2:60)]), sep = "_")

#join back with patients id's that were lost; 
cpt_HEDIS__table <- left_join(patients, cpt_freq_table)

str(cpt_HEDIS__table)
names(cpt_HEDIS__table)

#Divide Freq by length of observtion period (in years) to calculate average numbe per observation perios
cpt_HEDIS__table[,65:123] <- apply(cpt_HEDIS__table[,6:64], 2, function (x) {
          x/cpt_HEDIS__table$Observe_period_yrs})

#Rename Average columns
cpt_HEDIS_newnames <- (gsub('FREQ_', "AVERAGE_", colnames(cpt_HEDIS__table[,6:64])))
colnames(cpt_HEDIS__table)[65:123] <- paste(cpt_HEDIS_newnames)     
names(cpt_HEDIS__table)

###Presence of ICD diagnosis code - HEDIS 
# 0 = never had the icd code
# 1 = had the icd code at least once

cpt_HEDIS__table[,124:182] <- apply(cpt_HEDIS__table[,6:64], c(1,2), function(x) {
 ifelse(x == 0, 0, 1)})

cpt_HEDIS_newnames2 <- (gsub('FREQ_', "BINARY_", colnames(cpt_HEDIS__table[,6:64])))
colnames(cpt_HEDIS__table)[124:182] <- paste(cpt_HEDIS_newnames2)

names(cpt_HEDIS__table)
str(cpt_HEDIS__table)

# chanage NA's to zeros
cpt_HEDIS__table[,6:ncol(cpt_HEDIS__table)][is.na(cpt_HEDIS__table[,6:ncol(cpt_HEDIS__table)])] <- 0 
cpt_HEDIS__table <- cpt_HEDIS__table[-c(2:5)]

sum(is.na(cpt_HEDIS__table))

names(cpt_HEDIS__table)

#export HEDIS PROC variables to flat file folder
write.csv(cpt_HEDIS__table, "Z:/Flat File/pts_cpt_HEDIS.csv", row.names = FALSE)
  #Patient variables = 1
  #Freq HEDIS PROC codes = 2 - 60
  #Average HEDIS PROC codes = 61 - 119
  #Binary HEDIS PROC codes = 120 - 178
#FREQ was in baseline model


#Join to flat file - Merge with patient info, demo variables, and ICD variables
flat_file <- left_join(flat_file, cpt_HEDIS__table)
str(flat_file)
names(flat_file)
  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180
  #Average CCS ICD codes = 181 - 461
  #Binary CCS ICD codes = 462 - 741
  #Freq HEDIS PROC codes = 742 - 800
  #Average HEDIS PROC codes = 801 - 859
  #Binary HEDIS PROC codes = 860 - 918

```



####################  Variables from Encounter Table ####################



```{r}
####  Encounter Variables ####

min(encounters$Enc_DT_DS)  #2011-01-03
max(encounters$Enc_DT_DS)  #2016-12-30

pts_encounters <- inner_join(encounters,patients) #11,850,016 rows

##TRUE = Encounter was before first Hep C icd code
##FALSE = Encounter was NOT before first Hep C icd code
pts_encounters$before_diagnosis <- ifelse(pts_encounters$Enc_DT_DS < pts_encounters$First_Date_with_Hep_C_ICD_code, "TRUE", "FALSE") #Evaluate whether encounter was before or after first Hep C icd code date
pts_encounters <- pts_encounters[(pts_encounters$before_diagnosis=="TRUE"),]  #Remove "False" #11,568,781 rosw
dim(pts_encounters)



#Total_Num_Encounters
patient_ID_encounters<-data.frame(table(pts_encounters$PATIENT_ID))
colnames(patient_ID_encounters) <-  c("PATIENT_ID", "Total_Num_Encounters")
encounter_variables <- left_join(patients,patient_ID_encounters)
#Avg_Num_Encounters_Yr
encounter_variables$Avg_Num_Encounters_yr <- encounter_variables$Total_Num_Encounters / encounter_variables$Observe_period_yrs


##Outpatient 
#Total_Num_Outpt_Encounters
patient_ID_encounters_outpt <- data.frame(table(pts_encounters$PATIENT_ID[pts_encounters$Enc_EIO %in% c("O", "I, O", "E, O", "E, I, O")]))
colnames(patient_ID_encounters_outpt) <-  c("PATIENT_ID", "Total_Num_Outpt_Encounters")
encounter_variables <- left_join(encounter_variables,patient_ID_encounters_outpt)
#Avg_Num_Outpt_Encounters
encounter_variables$Avg_Num_Outpt_Encounters_yr <- encounter_variables$Total_Num_Outpt_Encounters  / encounter_variables$Observe_period_yrs



##Inpatient 
#Total_Num_Inpt_Encounters
patient_ID_encounters_inpt <- data.frame(table(pts_encounters$PATIENT_ID[pts_encounters$Enc_EIO %in% c("I", "I, O", "E, I, O", "E, I")]))
colnames(patient_ID_encounters_inpt) <-  c("PATIENT_ID", "Total_Num_Inpt_Encounters")
encounter_variables <- left_join(encounter_variables,patient_ID_encounters_inpt)
#Avg_Num_Inpt_Encounters
encounter_variables$Avg_Num_Inpt_Encounters_yr <- encounter_variables$Total_Num_Inpt_Encounters / encounter_variables$Observe_period_yrs

#Average_LOS_DAYS
LOS_Days <- subset(pts_encounters, LOS_Days >0)
average_LOS_Days <- aggregate(LOS_Days ~ PATIENT_ID, LOS_Days, mean, na.rm=TRUE)
average_LOS_Days$LOS_Days <- round(average_LOS_Days$LOS_Days, 2)
colnames(average_LOS_Days) <-  c("PATIENT_ID", "average_LOS_Days")
encounter_variables <- left_join(encounter_variables,average_LOS_Days)

#Avg_Num_Inpt_Admits
patient_ID_Inpt_Admits <- as.data.frame(table(LOS_Days$PATIENT_ID))
colnames(patient_ID_Inpt_Admits) <-  c("PATIENT_ID", "Total_Num_Inpt_Admits")
encounter_variables <- left_join(encounter_variables,patient_ID_Inpt_Admits)
encounter_variables$Avg_Num_Inpt_Admits_yr <- encounter_variables$Total_Num_Inpt_Admits / encounter_variables$Observe_period_yrs


###ED 
#Total_Num_ED_Encounters
patient_ID_encounters_ED <- data.frame(table(pts_encounters$PATIENT_ID[pts_encounters$Enc_EIO %in% c("E, I", "E", "E, I, O", "E, O")]))
colnames(patient_ID_encounters_ED) <-  c("PATIENT_ID", "Total_Num_ED_Encounters")
encounter_variables <- left_join(encounter_variables,patient_ID_encounters_ED)

#Avg_Num_ED_Encounters
encounter_variables$Avg_Num_ED_Encounters_yr <- encounter_variables$Total_Num_ED_Encounters / encounter_variables$Observe_period_yrs

#Avg_Num_ED_Visits
patient_ID_ED_visits <- data.frame(table(pts_encounters$PATIENT_ID, is.na(pts_encounters$ED_Arrival_DTTM_DS)))
patient_ID_ED_visits <- subset(patient_ID_ED_visits, Var2 == "FALSE")
patient_ID_ED_visits <- patient_ID_ED_visits[,-c(2)]
colnames(patient_ID_ED_visits) <-  c("PATIENT_ID", "Total_Num_ED_Visits")
encounter_variables <- left_join(encounter_variables,patient_ID_ED_visits)
encounter_variables$Avg_Num_ED_Visits_yr <- encounter_variables$Total_Num_ED_Visits / encounter_variables$Observe_period_yrs
encounter_variables <- encounter_variables[-c(17)]

##Billabe Encounters
#Total_Num_of_Encounters_by_billable_type
enc_billable_freq_table <- as.data.frame.matrix(table(pts_encounters$PATIENT_ID, is.na(pts_encounters$ENCOUNTER_ID)))
str(enc_billable_freq_table)
enc_billable_freq_table$PATIENT_ID <- rownames(enc_billable_freq_table) #Create a column for PATIENT_ID
enc_billable_freq_table <- enc_billable_freq_table[c(3, 1:2)]#move PATIENT_ID column to columns 1
rownames(enc_billable_freq_table) <- NULL#Remove row names from data.frame
enc_billable_freq_table <- enc_billable_freq_table[-c(3)]

#rename column names
colnames(enc_billable_freq_table)[2] <- paste("Total_Num_Billable_Enc")
enc_billable_freq_table$Total_Num_Billable_Enc <- as.numeric(enc_billable_freq_table$Total_Num_Billable_Enc)
#colnames(enc_billable_freq_table)[3] <- paste("Total_Num_Non_Billable_Enc")
#enc_billable_freq_table$Total_Num_Non_Billable_Enc <- as.numeric(enc_billable_freq_table$Total_Num_Non_Billable_Enc)

#join back with all patients that were lost; 
encounter_variables <- left_join(encounter_variables, enc_billable_freq_table)

#Divide Freq by length of observtion period (in years) to calculate average number per observation perios
encounter_variables$Avg_Num_Billable_Enc_yr <- encounter_variables$Total_Num_Billable_Enc / encounter_variables$Observe_period_yrs
encounter_variables <- encounter_variables[-c(18)]



#Total_Num_of_Encounters_by_Type
enc_type_freq_table <- as.data.frame.matrix(table(pts_encounters$PATIENT_ID, pts_encounters$Enc_Type_c))
enc_type_freq_table$PATIENT_ID <- rownames(enc_type_freq_table) #Create a column for PATIENT_ID
enc_type_freq_table <- enc_type_freq_table[c(50, 1:49)]#move PATIENT_ID column to columns 1
rownames(enc_type_freq_table) <- NULL#Remove row names from data.frame
#rename column names
colnames(enc_type_freq_table)[2:50] <- paste("FREQ_ENC_TYPE", colnames(enc_type_freq_table[,c(2:50)]), sep = "_")
names(enc_type_freq_table)
table(pts_encounters$Enc_Type_c)

#add back information on observation period
enc_type_table <- left_join(patients, enc_type_freq_table)
names(enc_type_table)

#Divide Freq by length of observtion period (in years) to calculate average number per observation perios
enc_type_table[,55:103] <- apply(enc_type_table[,6:54], 2, function (x) {
          x/enc_type_table$Observe_period_yrs})

#Rename Average columns
enc_type_newnames <- (gsub('FREQ_', "AVERAGE_", colnames(enc_type_table[,6:54])))
colnames(enc_type_table)[55:103] <- paste(enc_type_newnames)     
names(enc_type_table)
#eliminiate FREQ variables
enc_type_table <- enc_type_table[c(1, 55:103)]

#Join with other encounter variables
encounter_variables <- left_join(encounter_variables, enc_type_table)
names(encounter_variables)

#replace NA's with zeros
encounter_variables[,6:ncol(encounter_variables)][is.na(encounter_variables[,6:ncol(encounter_variables)])] <- 0
sum(is.na(encounter_variables))

#some columsn with very low numbers???????/
#colSums(encounter_variables[6:ncol(encounter_variables)])

#encounter_variables <- encounter_variables[,-c(18, 21, 29, 30, 32, 33, 35, 36, 44, 55)]

```


```{r}
####PCP History ###

#Total_Num_of_Unique_

#table(encounters$First_Enc_Service)
#sum(!is.na(encounters$Appt_Primary_Location))
```

```{r}
##Insurance_Aided - Did the patient ever recieve aid to cover medical bills?  
#TRUE = Fin Class listed "Charity", "Grants & Funds" or "medicaid" at least once in medical history
#FALSE = Fin Class wasd NEVER listed as "Charity", "Grants & Funds" or "medicaid"; no record in Fin Class is FALSE - should it be changed to unknown?

levels(pts_encounters$Fin_Class) <- c("Insured", "Insured", "Aided", "Aided", "Insured", 
                                                        "Insured", "Aided", "Insured", "Insured", "Insured", 
                                                        "Insured", "Insured", "Insured", "Aided", "Aided", 
                                                        "Aided", "Aided", "Insured", "Insured", "Insured",
                                                        "Insured", "Insured", "Self Pay", "Self Pay")
#Changed levels
#Insured = combines any commerical insurance plans and Medicare 
#Aided = combines Charity, Grants & Funds, Medicaid
#Self payy = self pay

patient_ID_insurance_aided <- data.frame(table(pts_encounters$PATIENT_ID[pts_encounters$Fin_Class == "Aided"]))
colnames(patient_ID_insurance_aided) <-  c("PATIENT_ID", "InsuranceAidedCt")
patient_ID_insurance_aided[,"InsuranceAidedCt"][is.na(patient_ID_insurance_aided[,"InsuranceAidedCt"])] <- 0

patient_ID_insurance_aided$Insurance_Aided <- ifelse(patient_ID_insurance_aided$InsuranceAidedCt>0,"TRUE", "FALSE")
patient_ID_insurance_aided <- patient_ID_insurance_aided[, c(1,3)] #remove count variable
encounter_variables <- left_join(encounter_variables, patient_ID_insurance_aided)
encounter_variables[,"Insurance_Aided"][is.na(encounter_variables[,"Insurance_Aided"])] <- "FALSE"
encounter_variables$Insurance_Aided <- as.factor(encounter_variables$Insurance_Aided)


#Insurance_Gap - Was there a ever a NA or self Pay listed as Fin Class?
##TRUE = a NA or self pay was listed at least once?
##FALSE = a insurance policy was always listed?  might want to include charity or grant funded????
### ??????????  Lots of pts have a NA listed on encounters???  will some encounters type not list insurance list?
patient_ID_insurancegap <- data.frame(table(pts_encounters$PATIENT_ID[(is.na(pts_encounters$Fin_Class)| pts_encounters$Fin_Class == "Self Pay")]))
colnames(patient_ID_insurancegap) <-  c("PATIENT_ID", "InsuranceGapCt")

patient_ID_insurancegap$Insurance_Gap <- ifelse(patient_ID_insurancegap$InsuranceGap>0,"TRUE", "FALSE")
patient_ID_insurancegap <- patient_ID_insurancegap[, c(1,3)] #remove count variable
encounter_variables <- left_join(encounter_variables, patient_ID_insurancegap)
encounter_variables[,"Insurance_Gap"][is.na(encounter_variables[,"Insurance_Gap"])] <- "FALSE"
encounter_variables$Insurance_Gap <- as.factor(encounter_variables$Insurance_Gap)

names(encounter_variables)

sum(is.na(encounter_variables))

encounter_variables <- encounter_variables[,-c(2:5)]

#export Encounter variables to flat file folder
write.csv(encounter_variables, "Z:/Flat File/pts_encounters.csv", row.names = FALSE)
  #Patient variables = 1
  #Totals and Averages on Encounter Type = 2 - 12
  #Average Encounter Type = 13 - 51
  #Insurance = 52 - 53
#FREQ was in baseline model


#Join to flat file - Merge with patient info, demo variables, ICD variables, and Procedure variables
flat_file <- left_join(flat_file, encounter_variables)
str(flat_file)
names(flat_file)
  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180
  #Average CCS ICD codes = 181 - 461
  #Binary CCS ICD codes = 462 - 741
  #Freq HEDIS PROC codes = 742 - 800
  #Average HEDIS PROC codes = 801 - 859
  #Binary HEDIS PROC codes = 860 - 918
  #Totals and Averages on Encounter Type = 919 - 980
  #Insurance = 981 - 982

```


####################  Variables from American Community Survey Data ####################


```{r}
#####  American Community survey Data ######

####  Finding Most Frequent zip Codes ###
#Zip_Code
#encounters_minus_NAzips <- encounters_first_hep_c_encounter[!is.na(encounters_first_hep_c_encounter$Zip_Code_DID),] #remove obserevations with NA's
#encounters_minus_NAzips <- encounters_minus_NAzips[,c("PATIENT_ID", "Zip_Code_DID")] #eliminate other variables in the encounters to speed things up
#encounters_minus_NAzips$Zip_Code_DID <- as.factor(encounters_minus_NAzips$Zip_Code_DID) #make it into a factor

#zip_code_freq_table <- as.data.frame.matrix(table(encounters_minus_NAzips$PATIENT_ID, encounters_minus_NAzips$Zip_Code_DID)) #create table with patient_ID's as rowns and zip codes as column
#str(zip_code_freq_table) 

#zip_code_freq_table$Most_Freq_Zip <- colnames(zip_code_freq_table)[apply(zip_code_freq_table, 1,which.max)]#creating a new column that gives which column has the highest value; ties goes to the lowest index 

#pts_zip_ACS <- zip_code_freq_table[,c(1,6778)] #reduce columns
#pts_zip_ACS$PATIENT_ID <- rownames(pts_zip_ACS) #Create a column for PATIENT_ID
#pts_zip_ACS <- pts_zip_ACS[c(3, 2)]#move PATIENT_ID column to columns 1
#rownames(pts_zip_ACS) <- NULL#Remove row names from data.frame


##Import Zip Code assignment file
zip_updates<-read_delim("Z:/ZipReassignmentForR_081317.csv", ",", escape_double = FALSE, trim_ws = TRUE)
str(zip_updates)
zip_updates$PATIENT_ID<-as.character(zip_updates$PATIENT_ID) 
zip_updates$PATIENT_ID<-str_pad(zip_updates$PATIENT_ID, 10, pad = "0")
zip_updates$Most_Freq_Zip<-as.character(zip_updates$NewZip) 


pts_zip_ACS <- left_join(zip_updates, ACS, c("Most_Freq_Zip" = "Zip_Code_DID")) #add ACS by matching on zip code; 954 zip codes unmatched???
dim(zip_updates)
dim(pts_zip_ACS)
sum(is.na(pts_zip_ACS))
str(pts_zip_ACS)

#remove NA's
pts_zip_ACS[,2:ncol(pts_zip_ACS)][is.na(pts_zip_ACS[,2:ncol(pts_zip_ACS)])] <- 0 
sum(is.na(pts_zip_ACS))

#remove zip code columns
pts_zip_ACS<- pts_zip_ACS[-c(2:3)]

#export CCS icd variables to flat file folder
write.csv(pts_zip_ACS, "Z:/Flat File/pts_zip_ACS.csv", row.names = FALSE)
  #Patient variables = 1
  #ACS Data = 2 - 43
#all was in baseline model


#Join to flat file - Merge with patient info, demo variables, and ICD variables
flat_file <- left_join(flat_file, pts_zip_ACS)
dim(flat_file)
names(flat_file)
  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180
  #Average CCS ICD codes = 181 - 461
  #Binary CCS ICD codes = 462 - 741
  #Freq HEDIS PROC codes = 742 - 800
  #Average HEDIS PROC codes = 801 - 859
  #Binary HEDIS PROC codes = 860 - 918
  #Totals and Averages on Encounter Type = 919 - 980
  #Insurance = 981 - 982
  #ACS data = 983 - 1024

```


####################  Variables from Social Table ####################


```{r}

#####  Social History Variables ####

#merge patient id's with social history table

dim(social_hx)
dim(patients)
pts_social <- left_join(patients, social_hx) #add demographics
dim(pts_social)

str(pts_social)
pts_social<-pts_social[order(pts_social$PATIENT_ID),]

#remove observations after First_Date_with_Hep_C_ICD_code; also removes observations where the Enc_DT_DS is blank because we are not able ot determine when the social survey was taken.
pts_social$BeforeorAfter <-ifelse(pts_social$First_Date_with_Hep_C_ICD_code=="9999-12-31", 1,
                                        ifelse(pts_social$First_Date_with_Hep_C_ICD_code < pts_social$Enc_DT_DS, 0, 1))

nrow(subset(pts_social, BeforeorAfter == 0))
nrow(subset(pts_social, BeforeorAfter == 1))
b
pts_social <- subset(pts_social, BeforeorAfter == 1)
#old_rows<-nrow(pts_social[1])
#remove duplicated rows - no duplicates present
#pts_social <- pts_social[!duplicated(pts_social),]
#new_rows<-nrow(pts_social)
#rows_deleted<-old_rows-new_rows; rows_deleted


##### Tobacco ####

###Convert all of these to Ever/Never/No Data = 2/1/0
#TOBACCO_USER
#SMOKING_TOB_USE
#SMOKELESS_TOB_USE
#CIGARETTES_YN
#PIPES_YN
#CIGARS_YN
#SNUFF_YN
#CHEW_YN

#then check if any of then have ever been answered with "2" before and mark the TOBACCO_USER_DER variable "Ever" if they have


#Recoding the TOBACCO_USER status variable -
#NA = 0
#0 = "Not Asked"
#1 = "Never"
#1 = "Passive"
#2 = "Quit"
#2 = "Yes"
pts_social$TOBACCO_USER_FCR<-pts_social$TOBACCO_USER
levels(pts_social$TOBACCO_USER_FCR) <- c("1", "0", "1", "2", "2")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$TOBACCO_USER_FCR[is.na(pts_social$TOBACCO_USER_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$TOBACCO_USER_FCR,pts_social$TOBACCO_USER)
pts_social$TOBACCO_USER_FCR <- as.numeric(as.character(pts_social$TOBACCO_USER_FCR))

#Recoding the SMOKING_TOB_USE status variable 

#2 - Current Every Day Smoker               
#2 - Current Some Day Smoker 
#2 - Former Smoker
#2 - Heavy Tobacco Smoker
#2 - Light Tobacco Smoker
#0 - Never Assessed
#1 - Never Smoker 
#1 - Passive Smoke Exposure - Never Smoker
#2 - Smoker, Current Status Unknown
#0 - Unknown If Ever Smoked


pts_social$SMOKING_TOB_USE_FCR<-pts_social$SMOKING_TOB_USE
levels(pts_social$SMOKING_TOB_USE_FCR) <- c("2", "2", "2", "2", "2", "0","1","1","0","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$SMOKING_TOB_USE_FCR[is.na(pts_social$SMOKING_TOB_USE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$SMOKING_TOB_USE_FCR)
pts_social$SMOKING_TOB_USE_FCR <- as.numeric(as.character(pts_social$SMOKING_TOB_USE_FCR))


#Recoding the SMOKELESS_TOB_USE status variable 
#2 - Current User
#2 - Former User
#1 - Never Used
#0 - Unknown
#Yes - 2

pts_social$SMOKELESS_TOB_USE_FCR<-pts_social$SMOKELESS_TOB_USE
levels(pts_social$SMOKELESS_TOB_USE_FCR) <- c("2", "2", "1", "0","2")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$SMOKELESS_TOB_USE_FCR[is.na(pts_social$SMOKELESS_TOB_USE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$SMOKELESS_TOB_USE_FCR)
pts_social$SMOKELESS_TOB_USE_FCR <- as.numeric(as.character(pts_social$SMOKELESS_TOB_USE_FCR))


#Recoding the CIGARETTES_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$CIGARETTES_YN_FCR<-pts_social$CIGARETTES_YN
levels(pts_social$CIGARETTES_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$CIGARETTES_YN_FCR[is.na(pts_social$CIGARETTES_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$CIGARETTES_YN_FCR)
pts_social$CIGARETTES_YN_FCR <- as.numeric(as.character(pts_social$CIGARETTES_YN_FCR))


#Recoding the PIPES_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$PIPES_YN_FCR<-pts_social$PIPES_YN
levels(pts_social$PIPES_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$PIPES_YN_FCR[is.na(pts_social$PIPES_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$PIPES_YN_FCR)
pts_social$PIPES_YN_FCR <- as.numeric(as.character(pts_social$PIPES_YN_FCR))


#Recoding the CIGARS_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$CIGARS_YN_FCR<-pts_social$CIGARS_YN
levels(pts_social$CIGARS_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$CIGARS_YN_FCR[is.na(pts_social$CIGARS_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$CIGARS_YN_FCR)
pts_social$CIGARS_YN_FCR <- as.numeric(as.character(pts_social$CIGARS_YN_FCR))


#Recoding the SNUFF_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$SNUFF_YN_FCR<-pts_social$SNUFF_YN
levels(pts_social$SNUFF_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$SNUFF_YN_FCR[is.na(pts_social$SNUFF_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$SNUFF_YN_FCR)
pts_social$SNUFF_YN_FCR <- as.numeric(as.character(pts_social$SNUFF_YN_FCR))


#Recoding the CHEW_YN status variable 
#2 - Y
#1 - N
#0 - Unknown

pts_social$CHEW_YN_FCR<-pts_social$CHEW_YN
levels(pts_social$CHEW_YN_FCR) <- c("1", "2","0")
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
pts_social$CHEW_YN_FCR[is.na(pts_social$CHEW_YN_FCR)] <- "0"
#nrow(subset(pts_social,is.na(TOBACCO_USER_DER)=="TRUE"))
table(pts_social$CHEW_YN_FCR)
pts_social$CHEW_YN_FCR <- as.numeric(as.character(pts_social$CHEW_YN_FCR))


### create extra variable that takes the max of the other tobacco-related variaables. If the person has ever marked Y on any of them, consider the "smoker"
#TOBACCO_USER
#SMOKING_TOB_USE
#SMOKELESS_TOB_USE
#CIGARETTES_YN
#PIPES_YN
#CIGARS_YN
#SNUFF_YN
#CHEW_YN

pts_social$TOBACCO_USER_STATUS_DER_ENC<-as.numeric("0")

i <-1
cols<-ncol(pts_social)
rows<-nrow(pts_social)
initial_time<-Sys.time()
while (i<=rows){
  ifelse(pts_social[i,(cols-8)]==0 & pts_social[i,(cols-7)]==0 & pts_social[i,(cols-6)]==0 & pts_social[i,(cols-5)]==0& pts_social[i,(cols-4)]==0& pts_social[i,(cols-3)] ==0 & pts_social[i,(cols-2)]==0 & pts_social[i,(cols-1)]==0, 0,  pts_social[i,cols]<- max(pts_social[i,(cols-8):(cols-1)]))
  i=i+1
  print(c("percent done ",i/rows))
  final_time<-Sys.time()
  }
final_time-initial_time          


#find max status of tobacco_user
#change formatting of object to factor
pts_max_status <- aggregate(TOBACCO_USER_STATUS_DER_ENC~PATIENT_ID,  data = pts_social, max)
colnames(pts_max_status) <- c("PATIENT_ID", "TOBACCO_USER_STATUS_DER")
pts_max_status$TOBACCO_USER_STATUS_DER<-as.factor(pts_max_status$TOBACCO_USER_STATUS_DER)
levels(pts_max_status$TOBACCO_USER_STATUS_DER) <- c("Unknown", "Never", "Ever")
#head(pts_max_status)
dim(pts_max_status)
str(pts_max_status)
table(pts_max_status$TOBACCO_USER_STATUS_DER)


#Add the variable to the patients table
social_variables<-left_join(patients,pts_max_status, by = "PATIENT_ID")
social_variables$TOBACCO_USER_STATUS_DER[is.na(social_variables$TOBACCO_USER_STATUS_DER)] <- "Unknown"


### Intentsity of tobacco use
pts_max_packs<-aggregate(TOBACCO_PAK_PER_DY~PATIENT_ID, data = pts_social,max)
colnames(pts_max_packs) <- c("PATIENT_ID", "TOBACCO_PAK_PER_DAY")
social_variables<-left_join(social_variables,pts_max_packs, by = "PATIENT_ID")
social_variables$TOBACCO_PAK_PER_DAY[is.na(social_variables$TOBACCO_PAK_PER_DAY)] <- 0


pts_social<-pts_social[order(-pts_social$TOBACCO_USER_STATUS_DER_ENC,pts_social$PATIENT_ID),]
#validate<-pts_social[,c(1:3,17,18,20,21,74)]


# number of years smoked
pts_max_years<-aggregate(TOBACCO_USED_YEARS~PATIENT_ID, data = pts_social,max)
colnames(pts_max_years) <- c("PATIENT_ID", "TOBACCO_USED_YEARS")
social_variables<-left_join(social_variables,pts_max_years, by = "PATIENT_ID")
social_variables$TOBACCO_USED_YEARS[is.na(social_variables$TOBACCO_USED_YEARS)] <- 0
#patients<-patients[,c(-6,-7)]



##### Alcohol ####
#alcohol related fields: 
#ALCOHOL_USE_C
#ALCOHOL_USE
#HX_DRINK_TYPES_C
#HX_DRINK_TYPES - not using -using alcohol use instead
#ALCOHOL_DRINKS_WK - data quality poor - field mostly blank
#ALCOHOL_OZ_PER_WK
#ALCOHOL_COMMENT

#Recoding the ALCOHOL_USE status variable -
#1 - No
#0 - Not Asked
#2 - Yes

pts_social$ALCOHOL_USE_FCR<-pts_social$ALCOHOL_USE
levels(pts_social$ALCOHOL_USE_FCR) <- c("1", "1","0", "2")
#nrow(subset(pts_social,is.na(ALCOHOL_USE_FCR)=="TRUE"))
pts_social$ALCOHOL_USE_FCR[is.na(pts_social$ALCOHOL_USE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(ALCOHOL_USE_FCR)=="TRUE"))
table(pts_social$ALCOHOL_USE_FCR)
pts_social$ALCOHOL_USE_FCR <- as.numeric(as.character(pts_social$ALCOHOL_USE_FCR))

#alcohol usage
pts_max_alc_use<-aggregate(ALCOHOL_USE_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_alc_use) <- c("PATIENT_ID", "ALCOHOL_USE_FCR")
social_variables<-left_join(social_variables,pts_max_alc_use, by = "PATIENT_ID")
social_variables$ALCOHOL_USE_FCR[is.na(social_variables$ALCOHOL_USE_FCR)] <- 0


## Alcohol intensiy - ALCOHOL_OZ_PER_WK
pts_social$ALCOHOL_OZ_PER_WK_FCR<-pts_social$ALCOHOL_OZ_PER_WK
pts_social$ALCOHOL_OZ_PER_WK_FCR[is.na(pts_social$ALCOHOL_OZ_PER_WK_FCR)] <- 0
pts_max_alc_oz<-aggregate(ALCOHOL_OZ_PER_WK_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_alc_oz) <- c("PATIENT_ID", "ALCOHOL_OZ_PER_WK_FCR")
social_variables<-left_join(social_variables,pts_max_alc_oz, by = "PATIENT_ID")
social_variables$ALCOHOL_OZ_PER_WK_FCR[is.na(social_variables$ALCOHOL_OZ_PER_WK_FCR)] <- 0



#### Sexual behavior ########

#Recoding the SEXUALLY_ACTIVE status variable -
#1 - No
#0 - Not Asked
#2 - Not Currently
#2 - Yes

pts_social$SEXUALLY_ACTIVE_FCR<-pts_social$SEXUALLY_ACTIVE
levels(pts_social$SEXUALLY_ACTIVE_FCR) <- c("1", "1", "0", "2","2")
#nrow(subset(pts_social,is.na(SEXUALLY_ACTIVE_FCR)=="TRUE"))
pts_social$SEXUALLY_ACTIVE_FCR[is.na(pts_social$SEXUALLY_ACTIVE_FCR)] <- "0"
#nrow(subset(pts_social,is.na(SEXUALLY_ACTIVE_FCR)=="TRUE"))
table(pts_social$SEXUALLY_ACTIVE_FCR)
pts_social$SEXUALLY_ACTIVE_FCR <- as.numeric(as.character(pts_social$SEXUALLY_ACTIVE_FCR))

#aggregate sexual activity to patient level
pts_max_sex_active<-aggregate(SEXUALLY_ACTIVE_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_sex_active) <- c("PATIENT_ID", "SEXUALLY_ACTIVE_FCR")
social_variables<-left_join(social_variables,pts_max_sex_active, by = "PATIENT_ID")
social_variables$SEXUALLY_ACTIVE_FCR[is.na(social_variables$SEXUALLY_ACTIVE_FCR)] <- 0

#Recoding the SEX_ENC_TYPE - type of sexual encounter. If the patient has ever had homosexual activity. 
#bring in the demographics table
pts_social<-left_join(pts_social,demo, by = "PATIENT_ID")

#Replace "NA" with U = unknown gender for the patient themselves
nrow(subset(pts_social,is.na(Gender)=="TRUE"))
pts_social$Gender[is.na(pts_social$Gender)] <- "U"
nrow(subset(pts_social,is.na(Gender)=="TRUE"))

#Clean data for the patients partner - Female partner
levels(pts_social$FEMALE_PARTNER_YN) <- c("N", "Y", "U")
nrow(subset(pts_social,is.na(FEMALE_PARTNER_YN)=="TRUE"))
pts_social$FEMALE_PARTNER_YN[is.na(pts_social$FEMALE_PARTNER_YN)] <- "U"
nrow(subset(pts_social,is.na(FEMALE_PARTNER_YN)=="TRUE"))

#Clean data for the patients partner - Male partner
levels(pts_social$MALE_PARTNER_YN) <- c("N", "Y", "U")
nrow(subset(pts_social,is.na(MALE_PARTNER_YN)=="TRUE"))
pts_social$MALE_PARTNER_YN[is.na(pts_social$MALE_PARTNER_YN)] <- "U"
nrow(subset(pts_social,is.na(MALE_PARTNER_YN)=="TRUE"))

#claculate if the the encounter was homosexual, heterosexual or Unknown
pts_social$Sex_Partner_Gender<-ifelse(pts_social$FEMALE_PARTNER_YN=="Y",ifelse(pts_social$MALE_PARTNER_YN=="Y","Mix","F"),ifelse(pts_social$MALE_PARTNER_YN=="Y","M","U"))
pts_social$sex_enc_type<-ifelse(pts_social$Gender=="U" | pts_social$Sex_Partner_Gender=="U","U",ifelse(pts_social$Sex_Partner_Gender=="Mix","HO",ifelse(pts_social$Gender==pts_social$Sex_Partner_Gender,"HO","HE")))
pts_social[100:200,c(1,75,40,41,86,87)]

#aggregate and bring into patients table
#if any homosexual axtivity has been recorded in the past, this variable is flagged HO.
pts_max_sex_enc_type<-aggregate(sex_enc_type~PATIENT_ID, data = pts_social,max)
colnames(pts_max_sex_enc_type) <- c("PATIENT_ID", "SEX_ENC_TYPE")
social_variables<-left_join(social_variables,pts_max_sex_enc_type, by = "PATIENT_ID")
social_variables$SEX_ENC_TYPE[is.na(social_variables$SEX_ENC_TYPE)] <- "U"
social_variables$SEX_ENC_TYPE<-as.factor(social_variables$SEX_ENC_TYPE)

#### Condom use
# y = 2
# N = 1
#n/a = 0

pts_social$CONDOM_YN_FCR<-pts_social$CONDOM_YN
levels(pts_social$CONDOM_YN_FCR) <- c("2","1", "2")
nrow(subset(pts_social,is.na(CONDOM_YN_FCR)=="TRUE"))
pts_social$CONDOM_YN_FCR <- as.numeric(as.character(pts_social$CONDOM_YN_FCR))
pts_social$CONDOM_YN_FCR[is.na(pts_social$CONDOM_YN_FCR)] <- "0"
nrow(subset(pts_social,is.na(CONDOM_YN_FCR)=="TRUE"))
pts_social$CONDOM_YN_FCR <- as.numeric(as.character(pts_social$CONDOM_YN_FCR))
table(pts_social$CONDOM_YN_FCR)


#aggregate sexual activity to patient level
pts_max_condom_use<-aggregate(CONDOM_YN_FCR~PATIENT_ID, data = pts_social,max)
colnames(pts_max_sex_active) <- c("PATIENT_ID", "CONDOM_YN_FCR")
social_variables<-left_join(social_variables,pts_max_sex_active, by = "PATIENT_ID")
social_variables$CONDOM_YN_FCR[is.na(social_variables$CONDOM_YN_FCR)] <- 0


##### Occupation#####
#the occupation field is mostly blank - build 2 factors: NA and everything else
pts_social$OCCUPATION_FCR<-pts_social$OCCUPATION

#pts_social$OCCUPATION_FCR[is.na(pts_social$OCCUPATION_FCR)] <- "0"

occupations<-data.frame(table(pts_social$OCCUPATION))

#remove NA's
sum(is.na(social_variables))

#export social variables to flat file folder
write.csv(social_variables, "Z:/Flat File/pts_social.csv", row.names = FALSE)
  #Patient variables = 1
  #Social = 2 - 7
#all was in baseline model


#Join to flat file - Merge with patient info, demo variables, ICD variables, procedure variables, encounter variables, and ACS variable
flat_file <- left_join(flat_file, social_variables)
str(flat_file[,1025:1032])
dim(flat_file)
names
  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180
  #Average CCS ICD codes = 181 - 461
  #Binary CCS ICD codes = 462 - 741
  #Freq HEDIS PROC codes = 742 - 800
  #Average HEDIS PROC codes = 801 - 859
  #Binary HEDIS PROC codes = 860 - 918
  #Totals and Averages on Encounter Type = 919 - 980
  #Insurance = 981 - 982
  #ACS data = 983 - 1024
  #Social = 1025 - 1032



```

  ###########  Variables from Med Input and Med Output Table###########
  
  
```{r}
####  Med Variables ####
names(meds_inpt)
names(meds_outpt)
reduced_meds_inpt <- meds_inpt[c(1, 4, 9)]
colnames(reduced_meds_inpt) <- c("PATIENT_ID", "DATE", "Thera_Class")
reduced_meds_outpt <- meds_outpt[c(1, 4, 8)]
colnames(reduced_meds_outpt) <- c("PATIENT_ID", "DATE", "Thera_Class")

pts_meds_inpt <- inner_join(reduced_meds_inpt,patients) #20,671,583  rows
pts_meds_outpt <- inner_join(reduced_meds_outpt,patients) #2,581,021 rows
dim(pts_meds)
pts_meds <- rbind(pts_meds_inpt, pts_meds_outpt) #23,252,604 rows

##TRUE = Order of Med was before first Hep C icd code
##FALSE = ORder fo Med was NOT before first Hep C icd code
pts_meds$before_diagnosis <- ifelse(pts_meds$DATE < pts_meds$First_Date_with_Hep_C_ICD_code, "TRUE", "FALSE") #Evaluate whether encounter was before or after first Hep C icd code date
pts_meds <- pts_meds[(pts_meds$before_diagnosis=="TRUE"),]  #Remove "False" #22,364,094 rosw
dim(pts_meds)


#Total_Num_of_Med_by_Pharmacy
med_type_freq_table <- as.data.frame.matrix(table(pts_meds$PATIENT_ID, pts_meds$Thera_Class))
med_type_freq_table$PATIENT_ID <- rownames(med_type_freq_table) #Create a column for PATIENT_ID
med_type_freq_table <- med_type_freq_table[c(48, 1:47)]#move PATIENT_ID column to columns 1
rownames(med_type_freq_table) <- NULL#Remove row names from data.frame
#rename column names
colnames(med_type_freq_table)[2:48] <- paste("FREQ_MED", colnames(med_type_freq_table[,c(2:48)]), sep = "_")
names(med_type_freq_table)

#add back information on observation period
med_type_table <- left_join(patients, med_type_freq_table)
names(med_type_table)

#Divide Freq by length of observtion period (in years) to calculate average number per observation perios
med_type_table[,53:99] <- apply(med_type_table[,6:52], 2, function (x) {
          x/med_type_table$Observe_period_yrs})

#Rename Average columns
med_type_newnames <- (gsub('FREQ_', "AVERAGE_", colnames(med_type_table[,6:54])))
colnames(med_type_table)[53:99] <- paste(med_type_newnames)     

#eliminiate FREQ variables
med_variables <- med_type_table[c(1, 53:99)]

#replace NA's with zeros
med_variables[,2:ncol(med_variables)][is.na(med_variables[,2:ncol(med_variables)])] <- 0
sum(is.na(med_variables))

colSums(med_variables[,2:ncol(med_variables)])

#export med variables to flat file folder
write.csv(med_variables, "Z:/Flat File/pts_meds.csv", row.names = FALSE)
  #Patient variables = 1
  #Med Class = 2 - 47
#all was in baseline model


#Join to flat file - Merge with patient info, demo variables, ICD variables, procedure variables, encounter variables, ACS variable, and social 
flat_file <- left_join(flat_file, med_variables)
str(flat_file[,1033:1079])
dim(flat_file)

  #Patient variables = 1-5
  #Demographic variables = 6-12
  #Freq HEDIS ICD codes = 13- 68
  #Average HEDIS ICD codes = 69 - 124
  #Binary HEDIS ICD codes = 125 - 180
  #Average CCS ICD codes = 181 - 461
  #Binary CCS ICD codes = 462 - 741
  #Freq HEDIS PROC codes = 742 - 800
  #Average HEDIS PROC codes = 801 - 859
  #Binary HEDIS PROC codes = 860 - 918
  #Totals and Averages on Encounter Type = 919 - 980
  #Insurance = 981 - 982
  #ACS data = 983 - 1024
  #Social = 1025 - 1032
  #Meds = 1033 - 1079

```


```{r}
#####  Double Check flat File & Export

sum(is.na(flat_file))  # should be zero NA's 

dim(flat_file)  #232661   1079
str(flat_file[1:150])
str(flat_file[151:300])
names(flat_file)
write.csv(flat_file, "Z:/Flat File/patients_all_variables_09-07-2017.csv", row.names = FALSE)
```

```{r}

######  STOP #####
###  NOT FINISHED ####



### CCS categories ####

###  Import CCS CPT categories  ####

cpt_CCS <- read.csv("Z:/Value Sets/2017_ccs_services_procedures.csv", header = TRUE, stringsAsFactor = FALSE)

#Formatting CCS file
cpt_CCS$Code.Range <- sub(".$", "", cpt_CCS$Code.Range)#remove last character in string
cpt_CCS$Code.Range <- sub("^.", "", cpt_CCS$Code.Range)#remove first character in string

cpt_CCS$Code.Range <- trimws(cpt_CCS$Code.Range, which = c("right")) #remove extra spaces
#cpt_CCS$Code.Range <- str_pad(cpt_CCS$Code.Range, 5, "right", pad = "0") #add zeros at the end

code_ranges <- strsplit(as.character(cpt_CCS$Code.Range), "-", fixed = TRUE)
cpt_CCS$Code.Range_1 <- sapply(code_ranges, "[", 1)
cpt_CCS$Code.Range_2 <- sapply(code_ranges, "[", 2)

cpt_CCS <- cpt_CCS [c("X.ICD.9.CM.CODE.",  "CCS.CATEGORY", "X.CCS.CATEGORY.DESCRIPTION.")]
colnames(cpt_CCS) <- c("Code", "CCS_CATEGORY", "CCS_DESC")

str(cpt_CCS)




```


```{r}
####  COMBINE codes from cpt and cpt_ucpg ###

reduced_cpt <- cpt[c("PATIENT_ID", "enc_dt_ds", "CPT", "CPT_Procedure", "QUANTITY")]
colnames(reduced_cpt) <- c("PATIENT_ID", "Date", "Code", "Desc", "Quantity") 
reduced_cpt$Code <- as.character(reduced_cpt$Code)

sort(reduced_cpt$Code, decreasing = FALSE)

#reduced_cpt_ucpg <- cpt_ucpg[c("Patient_Id", "Date_of_Service_DS", "CPT_Code")]
#colnames(reduced_cpt_ucpg) <- c("PATIENT_ID", "Date", "Code")
#reduced_cpt_ucpg$Desc <- NA

### CHOOSE WHICH TABLES TO USE BY REMVOING TABLES!!##
#all_cpt <- rbind(reduced_cpt, reduced_cpt_ucpg)
all_cpt <- reduced_cpt
str(all_cpt)


#join cpt codes to ccs categories
cpt_codes_ccs <- left_join(all_cpt, cpt_CCS, by = c("Code" = "Code.Range_2"))
dim(cpt_codes_ccs)
dim(all_cpt)
dim(cpt_CCS)

all_cpt <- ifelse(all_cpt)
str(cpt_codes_ccs)

sum(is.na(cpt_codes_ccs$CCS))

subset(cpt_codes_ccs, !(is.na(CCS)))
```