---
title: "capstone_variablecreation"
author: "Laura Olson"
date: "May 20, 2017"
output: html_document
---

#Segment patients with hep c at first encounter vs. after

#Create table patients

```{r}

library(dplyr)

#include patients whose first encounter date was = to first Hep C icd code
patients_include <- subset(hep_c_patients_first_encounter_date_and_first_hep_c_icd_code, EncountervsICD == "TRUE")

#merge table with all unique patient ID's with the patients with a hep c diagnosis
patients <- left_join(merge_10,patients_include)

#Add column to identify as hep c = 1 and non hep c = 1
patients$HCV_STATUS <- ifelse(is.na(patients$First_Date_with_Hep_C_ICD_code),0,1)

#reduce to only patient ID and HCV status
patients <- patients[,c(1, 13, 14, 16)]

dim(patients)
str(patients)


#double check - should be 2485
nrow(subset(patients, HCV_STATUS ==1))

####NOT WORKING3###
#change date NA's to 12/31/9999 
patients[is.na(patients$First_Date_with_Hep_C_ICD_code),] <- as.Date("12-31-9999")
```

```{r}
#######Demo Varialbes#####

#merge patient id's with demo table

dim(demo)
dim(patients)
pts_demo <- left_join(patients, demo) #add demographics
dim(pts_demo)

str(pts_demo)


pts_demo <- pts_demo[,c( "PATIENT_ID", "HCV_STATUS", "DOB_DS", "Gender", "Race", "Ethnicity", "language", "Marital_Status",      "DOD_DS")] #reducing down the columns
names(pts_demo)[c(3:9)] <- c("DOB","GENDER", "RACE", "ETHNICITY", "LANGUAGE", "MARITAL_STATUS", "DOD") #rename columns

library(eeptools)
## DOB ##
pts_demo$age_T0 <- age_calc(dob = DOB, enddate = , units = "years")

## reduce Language levels to 2

levels(pts_demo$language)

levels(pts_demo$LANGUAGE) <- c("Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English",
"Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English",
"Non-English", "Non-English", "Non-English", "Non-English", "Non-English", "Non-English") #reducing language to 2 factors

#reduce Marital Status levels to 4

levels(pts_demo$MARITAL_STATUS) <- c("Married_Committed", "Married_Committed", "Unknown", "Divorced_Separated", 
                                     "Divorced_Separated", "Unknown", "Unknown", "Unknown", 
                                     "Unknown", "Divorced_Separated", "Divorced_Separated", "Unknown", 
                                     "Unknown", "Married_Committed", "Unknown", "Unknown", 
                                     "Married_Committed", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Single", "Unknown", 
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                     "Unknown", "Unknown", "Unknown", "Unknown",
                                    "Widowed", "Unknown", "Unknown", "Unknown", 
                                    "Unknown", "Unknown")
```

```{r}

#####  Social History Variables ####

#merge patient id's with social history table

dim(social_hx)
dim(patients)
pts_social <- left_join(patients, social_hx) #add demographics
dim(pts_social)

str(pts_social)

#remove observations after First_Date_with_Hep_C_ICD_code
pts_social$BeforeorAfter <-ifelse(is.na(pts_social$First_Date_with_Hep_C_ICD_code), 1,
                                        ifelse(pts_social$First_Date_with_Hep_C_ICD_code < pts_social$Enc_DT_DS, 0, 1))

nrow(subset(pts_social, BeforeorAfter == 0))
nrow(subset(pts_social, is.na(BeforeorAfter)))
nrow(subset(pts_social, BeforeorAfter == 1))

pts_social <- subset(pts_social, BeforeorAfter == 1)

#remove duplicated rows
pts_social <- pts_social[!duplicated(pts_social),]


##### Tobacco ####
#Recoding the Tobacco User status variable -


#NA = 0
#0 = "Not Asked"
#1 = "Never"
#1 = "Passive"
#2 = "Quit"
#2 = "Yes"
levels(pts_social$TOBACCO_USER) <- c("1", "0", "1", "2", "2")
pts_social$TOBACCO_USER[is.na(pts_social$TOBACCO_USER)] <- "0"
table(pts_social$TOBACCO_USER)

pts_social$TOBACCO_USER <- as.numeric(as.character(pts_social$TOBACCO_USER))

#find max status of tobacco
#change formatting of object to factor
pts_max_status <- aggregate(TOBACCO_USER~PATIENT_ID,  data = pts_social, max)
colnames(pts_max_status) <- c("PATIENT_ID", "TOBACCO_USE_STATUS")
pts_max_status$TOBACCO_USE_STATUS<-as.factor(pts_max_status$TOBACCO_USE_STATUS)
levels(pts_max_status$TOBACCO_USE_STATUS) <- c("Unknown", "Never", "Ever")

head(pts_max_status)
dim(pts_max_status)
str(pts_max_status)


### Figure out a tobacco intensity variable????????????? ####

##### Alcohol ####
sum(is.na(pts_social$ALCOHOL_USE_C))
`levels<-`(addNA(pts_social$ALCOHOL_USE), c(levels(pts_social$ALCOHOL_USE), "Unknown"))
pts_social$ALCOHOL_USE[is.na(pts_social$ALCOHOL_USE_C)] <- "0"
table(pts_social$ALCOHOL_USE)
levels(pts_social$ALCOHOL_USE_C)
pts_social$ALCOHOL_USE <- as.numeric(as.character(pts_social$ALCOHOL_USE))

pts_social$ALCOHOL_USE <- as.numeric(as.character(pts_social$ALCOHOL_USE))
df[is.na(df$a),1] <- 88
df$a <- as.factor(df$a)




```

```{r}

######ICD Diagnosis Codes Table#########

###import value sets
Value_Sets<- read.csv("Z:/Hepatitis C Project/Value Sets/Value Sets.csv", header = TRUE, stringsAsFactor = FALSE)
str(Value_Sets)

#filter on certain categaries
reduced_value_sets <- Values_Set %>%
                        filter(Value_Set_Name == "Sexual Activity", Code_System == ICD10PCS, ICD9PCS, ICD10CM, ICD9CM, HCPCS
)

#Create table with 1/0's for icd codes

library(dummies)

dim(diagnosis_icd)
dim(patients)
pts_diagnosis <- left_join(patients, diagnosis_icd) #add demographics
dim(pts_diagnosis)

str(pts_diagnosis)

#remove observations after First_Date_with_Hep_C_ICD_code
pts_diagnosis$BeforeorAfter <-ifelse(is.na(pts_diagnosis$First_Date_with_Hep_C_ICD_code), 1,
                                        ifelse(pts_diagnosis$First_Date_with_Hep_C_ICD_code < pts_diagnosis$Enc_DT_DS, 0, 1))

#remove observations that occurred after Hep C diagnosis
pts_diagnosis <- pts_diagnosis[(pts_diagnosis$BeforeorAfter == 1),]

patient_icd_codes <- pts_diagnosis[c(1,7)]
str(patient_icd_codes)


dummy(sexual_codes,drop=T)
?dummy.data.frame

model.matrix(PATIENT_ID ~icd_dx - 1, data = sexual_codes)
model.matrix(~ icd_dx - 1, sexual_codes) 
head(dummies)

for (levels in unique(sexual_codes$icd_dx)) {
  sexual_codes[paste("Code", levels, sep = "")] <- ifelse(sexual_codes$icd_dx == levels, 1, 0)
}

?model.matrix
# example data
df1 <- data.frame(id = icd_code_freq$PATIENT_ID, icd_code = icd_code_freq$icd_dx)
head(df1)
df1 <- cbind(df1$id, dummy(df1$icd_code, sep = "_"))
dim(df1)
names(df1)



#Create table with frequency of icd codes



#####  Code for single icd factor level ###
icd_078.11_freq <- as.data.frame(filter(sexual_codes, icd_dx == "078.11") %>%
  count(PATIENT_ID))
colnames(icd_078.11_freq) <- c("PATIENT_ID", "icd_078.11_freq")
g
patients <- left_join(patients, icd_078.11_freq)
patients$icd_078.11_freq[is.na(patients$icd_078.11_freq)] <- 0
  
icd_codes <- unique(sexual_codes$icd_dx)
icd_codes <- levels(droplevels(icd_codes))
str(icd_codes)
  
for(x in levels(icd_codes)) { 
a <- as.data.frame(filter(sexual_codes, icd_dx == "x") %>%
  count(PATIENT_ID))  #filters by specific icd_dx level and counts the number of times a specific patient has that icd code
colnames(a) <- c("PATIENT_ID", paste("icd_", x, "_freq")) #renames the data.frame columans

patients <- left_join(patients, a) #joins with full id dataset
}
  
icd_freq_variable <- names(patients[5:12000])
for(x in levels(icd_freq_variable))
patients$x <- if(patients$x == 0, 0, 1))#need to find a way to name it
```